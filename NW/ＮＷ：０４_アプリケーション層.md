# ＮＷ：０４_アプリケーション層
## とは
### アプリケーション特有のプロトコルを扱う層、OSI基本参照モデルのセッション層、プレゼンテーション層、アプリケーション層に当たる
## Web関連プロトコル
### HTTP：HyperText Transfer Procotol
#### クライアントのリクエストに対してサーバがレスポンス応答のが典型的なやりとり
##### HTTP1.0では、一つのリクエスト−レスポンスをやり取りするたびにTCPコネクションを確立／切断していたが、HTTP1.1では、１回のTCPコネクションで複数のリクエスト−レスポンスをやりとりすることが可能です
#### HTTPメッセージ
##### リクエスト
###### メソッドを記述するリクエストライン
* 全体の一行目：メソッド　リクエストURI  HTTPバージョン
    * URI：Uniform Resource Identifier：RFC3986
    * メソッド
        * GET
            * 指定したURIのデータ取得
        * POST
            * データ格納
        * PUT
            * 置き換え
        * PATCH
            * 部分変更
        * DELETE
            * 削除
        * HEAD
            * GETと同じ、ヘッダのみあり、リスポンスメッセージなし
        * CONNECT
        * TRACE
            * 目標試験までのテスト
        * OPTIONS
            * 目標リソースの通信オプション
###### リクエストヘッダ
* 主なパラメータ
    * Accept
        * 受入可能なメディタイプ
    * Authorization
        * HTTPアクセス認証の認証情報
    * Referer
        * 直前に閲覧していたURI
            * オプションので、ない可能性がある
    * Cookie
        * クライアント側でのクッキーを設定
    * User−Agent
        * ユーザのシステムやブラウザに関する情報
###### メッセージボディ
##### レスポンス
###### ステータスコードを記述するステータスライン
* 全体の一行目：HTTPバージョン　ステータスコード　説明句
    * ステータスコード
        * 100番台は正常処理中
            * 例
                * 100：Continue：暫定的に受入中
        * 200番台は正常に処理した
            * 例
                * 200：OK
        * 300番台はさらに動作が必要
            * 例
                * 304：Not Modified：文書は更新されていない
        * 400番台は間違ったリクエストなどクライアント側の事由により処理不可
            * 例
                * 401：Unauthorized：ユーザ認証が必要
                * 404：Not Found：見つからなかた
        * 500番台はサーバのエラーを示す
            * 例
                * 500：Internal Server Error：内部サーバエラー
###### レスのポンスヘッダ
* 主なパラメータ
    * Location
        * URI以外の場合にリダイレクト
    * Set−Cookie
        * クッキーを発行
    * Content−Type
        * 転送されるコンテンツの形式や文字コード
    * X−Content-Type-Options
        * Content−Typeに合致しないコンテンツの動作決定
    * Content Security Policy
        * ブラウザでセキュリティ対策を行う機能を有効化
    * X-Frame-Options
        * フレーム内の表示制限の設定
    * Strict-Transport-Security
        * HSTS機能の有効化、指定URLに対して次回以降のアクセスは強制的にHTTPSで行うように指示
    * X-XSS-Protection
        * ブラウザでクロスサイトスクリプティング対策を行う機能を有効化
###### メッセージボディ
#### クッキー
##### 通信しているユーザの情報を続けて管理するためのもの
###### 例：セッションクッキー
* URLにセッションキーを埋め込み手法を、URLリライトリングを呼ばれる
###### Secure属性を追加すると、HTTPSの場合のみ使える用になり
#### HTTP認証
##### RFC2617
###### ベーシック認証
* IDとパスワードを用いて行う認証、「利用者ID：パスワード」の様に二つの値を“：”（コロン）で連結してBASE64でエンコードしたデータを送出し、認証を行う
    * 明文ので、盗聴が可能です
###### ダイジェスト認証
* Basic認証の明文問題を解消、チャレジコード（リプレイ）とハッシュ化を導入（盗聴）
    * １．サーバからランダムな値をクライアントへ送付（チャレンジコード）
    *  2．クライアントは、パスワードにランダム文字列付与してハッシュ化（チャレンジコード）
    * 3、クライアントで「ID：チャレンジコード」をBASE64して、サーバへ送信して認証を行う
#### WebSocket
##### HTTPを用いてサーバとクライアントが一度コネクションを確立した後、必要な通信を全てコネクション内で独自のプロトコルで軽量に行うことで、両方向での通信を容易にする
###### 最初の通信はhttpのGETメソッドで始まり、クライアントとサーバ間でハンドシェイクをして接続が確立
* コネクション確立後、必要な通信をすべてコネクション内で独自のプロトコルで軽量に行うことで、両方向での通信を容易にする
###### ポートが変わらないですが、
専用のwsプロトコルあり、一部ファイアウォールでブロックされるケースがある
###### 通信は両方向だが、最初の通信はクライアント側から行うが必要
#### DSR：Direct Server Return
##### Inbound経路はLB経由、outboundをサーバから直接出せる
###### そのため、LBはIPを変えないで（変える際に、もとのIPはX-Forwadingに存在）、かつサーバ側このパケットを受信するためにLBのアドレスをループバックインタフェースにLBの IPアドレスを追加が必要
### プロキシ
#### クライアントとサーバの間で情報を代理する中継
##### Webサーバへアクセスの流れ
###### １．クライアントがプロキシサーバに対して、URIを指定して通信を要求する
######  2．プロキシサーバが、URIに対応する IPアドレスを知るために、DNSサーバに問合せを行う
###### 3．DNSサーバから、URIに対応するIPアドレスを返却
###### 4．プロキシサーバがウェブサーバに代理でアクセスする
###### 5．Webサーバからプロキシサーバに応答する
###### 6．Webサーバからの応答をクライアントへ返答する
##### 特徴
###### キャッシュを保存によるの高速なアクセス
###### 安全な通信
* クライアントのPC情報を外部に漏れず、安全な通信が実現できる
* 有害なサイトをプロキシサーバで遮断もできる
    * 一部はURLや内容によるのフィルター機能が持つ
###### データの変換
* クライアントが対応していないプロトコルでの通信も、プロキシサーバで中継することで可能になる
    * IMAPのみでIMAPSに対応していないクライアントの通信をIMAPSに変換して通信することが可能
    * 自動翻訳や文字コード変換も可能
###### HTTPとは限らなく、HTTPSやメール関連のSMTP、IMAPなど様々なプロトコルに対応させることが可能
##### 設定
###### クライアント側
* OSのネット環境設定で手動設定
* PAC（スクリプト）を利用して自動設定
    * クライアントはPACファイルのURIを設定し、自動的にPACを取得して利用するプロキシを設定する
* WPAD（Web Proxy Auto−Discovery Procotol）を利用して自動設定
    * DHCPサーバに新しいオプションとしてWPADを追加する、またはDNSにwpad.＜ドメイン名＞という名前を登録しておくなどの手法で、プロキシサーバ側の設定をクライアントに知らせる
        * DHCP：PACファイルのアドレスを指定可能
        * DNS：自動的のwpad.＜ドメイン名＞を段々上で行って試す
            * wpad.mms.co.up/wpad.datを試行で取れない場合自動的に上のwpad.co.up/wpad.datに行く
            * DNSが攻撃された場合不正誘導はできる
            * クライアント設定が不要の一方、セキュリティ面要注意
### リバースプロキシ
#### 専用のプロキシ、不特定多数のクライアントを代理し、特定のサービスへの要求を中継する
##### 対照のは、プロキシは一般的に不特定多数のクライアントを代理して、それぞれ不特定多数のサーバへの要求を中継する
##### 特徴
###### 負荷分散
* 複数のサーバに処理を振り分けことができる
###### キャッシュによる負荷低減
###### 暗号化（TLS高速化）
* TLSによる通信をリーバスプロキシサーバが行うことで、サーバに負荷をかけることなく暗号化や認証を実現できる
    * ポート情報が識別できなくなる要注意
### Webアクセス技術
#### CORBA：Common Object Request  Broker Architecture
##### 分散環境でオブジェクト間のメッセージをやり取りするためにOMG（Object Management Groupt）が定義した標準規格
###### インターネットでは一般的ではないIIOP（Internet  Inner−ORB Protocol）というプロトコルが用いられているため、ファイアウォール設定の変更などが必要です．そのため、閉じたLAN上ではないインターネット上の通信にはあんまり向いていない
#### Webサービス
##### SOAP：Simple Object Access Procotol
###### ソフトウェア同士がメッセージを交換するためのプロトコルです．HTTPやSMTPなどのプロトコルの上位に位置し、XML形式でメッセージ交換を行い
* XML文書に対して、エンベロープと呼ばれる付加情報を自由に追加することができる
##### WSDL：Web Services Description  Language
###### Webサービスのインターフェースを定義する技術：場所、メッセージフォーマット、プロトコルなどが定義されている
##### UDDI：Universal Description、Discovery  and Integration
###### Webサービスを公開及び検索する技術です
#### ECMAScript関連
##### Javascript（Netscape）やJScript（MS）などのWebブラウザ上で動けるスクリプト言語の共通する部分をまとめて標準化したもの
###### Ajax：Asynchronous JavaScript＋XML
* Webブラウザ上で非同期通信の手段
    * 新技術ではなく、GMAIL始まり？従来の技術を組み合わせることで非同期通信を実現する
###### Same−Originポリシ
* スキーム、ポート番号、ホスト（FQDNやIPアドレスなど、Webサービスのホスト）の三つが全て等しいが必要
    * Same−Originではないかつ許可指定しないの場合、スクリプトの実行やリソースのアクセスを制限されることがある
#### WebDAV：Web−Based  Distributed Authoring  and Versioning
##### FTPと代替できるプロトコルで、HTTPだけでWebサーバに対してフィアルのコピーや削除を行うができるプロトコル
###### HTTPを拡張し、HTTPリクエストヘッダーのメソッドを追加した．例、COPY、LOCK、MKCOL、MOVE、PROPFIND、PROPPATCH、UNLOCK
* 利用製品のサポート状態確認要
#### マッシュアップ
##### 複数の提供元によるAPIを組み合わせることで新しいサービスを提供する技術
###### 例：Goolge Mapの地図情報を活用して地図を表示しながら、店舗夜間高知のロコミ情報を載せるサイトなど
#### MQTT：Message Queuing Telemetry Transport
##### インターネットなどのTCP／IPネットワーク上で利用できる通信プロトコル、HTTPと比べて軽量、省電力で利用できるので、IoTに適した技術
###### Publish／Subscribeモデル、その間の通信をMQTTサーバが中継する、MQTTサーバがメッセージを補完するので、PublisherとSubscriberが意識せずにメッセージを送信することができる
#### CoAP：Constrained Application  Protocol
##### UDP上動作する簡単にインターネット上で通信を行うためのプロトコル、RFC7252で標準化され
###### HTTPに似たプロトコルで、HTTPリクエストをCoAPリクエストに変換できる
## メール関連プロトコル
### メール通信の歴史
#### 初登場のSMTPは送信側と受信側の両方にオンライン状態を前提に転送を行うプロトコル
##### インターネット黎明期、大学などの期間を結ぶのものはほとんどです、SMTPでは信頼できる相手とのやり取り考慮されていない
##### 通常のPCなどでは送受信がうまく行かれません
###### そのため、電源を落とさないメールサーバーにメールを保管しておき、必要に応じてPCからアクセスしてメールを受信するPOP（Post  Office Protocol）などが登場した
### 代表的なプロトコル
#### メール送信
##### SMTP：Simple Mail Transfer Procotol
###### 主なコマンド
* HELO
    * 通信開始
* EHLO
    * 通信開始（拡張版HELO）
        * サーバが拡張された仕様に対応している内容が返される
            * 例：EHLO example.com
                * 返信：
250-MTA301.mail***.****.co.jp
250-8BITMIME
250-SIZE 31457280
250 PIPELINING
* MAIL FROM:
    * 送信者
* RCPT TO:
    * 受信者の指定（Receipt to）
        * 宛先メールアドレスが複数ある時には、1件ずつRCPTコマンドでRCPT  TO:として送信する
* DATA
    * メール本文の送信
* QUIT
    * 終了
###### 主なSMTPリプライ
* 200番台は正常な受理（処理の完了）
    * 例
        * 250
            * 要求された処理の完了
* 300番台は正常な処理の中間的な回答（処理注）
    * 例
        * 354
            * メールデータの入力開始「.ピリオド」だけの行で入力終了
* 400番台は転送失敗などの一時的なエラー
    * 例
        * 451
            * 問題が発生したため処理を中断
* 500番台は処理継続不可能なエラー
    * 例
        * 500
            * 文法の誤り
###### 正常流れの例
* —>EHLO mail.xxx.com
<--250
—>MAIL FROM:<useraa@xxx.com>
<—250
—>RCPT TO:userbb@yyy.com
<—250
—>DATA
<—354
—>mail content[ln].[ln]<—250 
###### 不正中継問題
* 初期のsendmailなどでは、オープンリレーがディフォルト設定となっていた
###### 迷惑メール防止のために、サブミッションポート587番など、メールクライアントからの電子メール送信で通常使用された25番とは違うポートで送信することが可能
* Non−Encrypted
    * 25 or 587
* Secure(TLS)
    * 587
* Secure(SSL)
    * 465
#### メール取得
##### POP：Post Office Procotol
###### サーバ上にあるメールをクライアントへダウンロードし、サーバ側は一般的に削除する
* 主なコマンド
    * USER
        * ユーザ名の送信
    * PASS
        * パスワードの送信
    * APOP
        * Authenticated POP
            * ハッシュ関数のMD5を利用してチャレンジレスポンス方式パスワードを送る
                * ←脆弱性あり、2021年今はTLS推奨
    * LIST
        * メールの確認、一覧表の取得
    * RETR
        * メールのメッセージ取得
    * QUIT
        * 終了
* 主なPOPリプライ
    * +OK
        * 正常
    * -ERR
        * エラー発生
* 流れ
    * クライアントサーバ型のプロトコル、まずコネクション確立が必要、確立後、まずサーバから準備ができたことを示す「+OK」が返され
        * <— +OK
—> USER usernameaa
<— +OK
—> PASS ******
<— +OK
—> LIST
<— +OK[ln]メール1[ln]メール2[ln]....[ln]
—> RETR 1
<— メール本文[ln].[ln]
* ポート
    * Default non-encrypted
        * 110
    * secure
        * 995
##### IMAP：Internet Message Access  Protocol
###### POPと違う点は、メールを全てダウンロードしてサーバから削除せず、サーバ側で管理する。メールの既読管理やフォルダ管理もサーバで行う
* 複数のコンピュータから同じアカウントでメールを読む場合に一元に管理できる
    * ログインなどの基本的なコマンドはPOPと同等です、IMAPでは、クライアントに保管されているメールをサーバに保存することも可能
#### 関連プロトコル
##### MIME：Multipurpose Internet  Mail Extensions
###### 以前はテキストデータしか扱えない時代でも、画像や動画、プログラムなど様々な種類のバイナリデータ送られる用にするためのデータ形式
* 構成
    * ヘッダ部
        * メールの送信元や宛先、件名、MIMEのバージョン、Content-Type、エンコーディングなど
    * ボディ部
        * 通常のテキスト（text/plain）のデータ
        * バイナリデータ
###### 汎用的なデータ形式のプロトコル、メール以外SIPなどの様々なプロトコルも使用され
##### 認証の仕組み
###### POP before SMTP
* SMTPの前にPOPを通じてクライアントを認証し、その後の一定期間だけ、同じIPアドレスからのSMTP通信を許可する
###### SMTP-AUTH
* SMTP拡張（ELHOで確認できる）、クライアントとサーバの両方がサポートが必要。クライアントとサーバとの間でユーザ名とパスワードなどによって認証を行う方式
###### OP25B：OutBound Port 25 Blocking
* 迷惑メールの送信に自社のネットワークを使われないようにするためのプロバイダ対策。25番ポートの禁止により、契約しているプロバイダから会社のメールサーバ経由でメールを送るのはサブミッションポート（587）を使う、サブミッションポートではSMTP−AUTHが必須です
    * 25番を禁止することで、認証なしでSMTPで自社メールを踏み台などの扱いが禁止され
    * 一般的にISPが、自ISPの下のメールサーバから外部へのメールの直接送信（SMTPの25番ポート）を禁止され、ブロック対象は管理したで顧客に割り当てられる動的IPアドレス．自社グローバルIPが持っているメールサーバはブロックしない
###### SPF：Sender Policy Framework
* 送信ドメイン認証の一つ、差出人のメールアドレスが他のドメインになりすましていないかを検証する
    * 実現：DNSサーバにSPFレコードを追加する、SPFレコードには、ドメイン名に対応するIPアドレスの範囲を記述しておき、それ以外のIPアドレスからの通信を信頼しないように設定する
        * SPFレコード例：
            * IN TXT “v=spf1 +ip4:110.245.210.56 -all”
                * +で指定のIP以外からのメールをドメインを詐称していることが示され
        * 送信メールサーバのIPアドレスが変更する際に、DNSキャッシュを有効期限を考慮が必要
###### DKIM：DomainKeys Identified Mail
* ディジタル署名を用いて送信ドメイン認証を行う方法、ディジタル署名検証用の公開鍵は、予めDNSで公開する
    * メールサーバで送信メールにディジタル署名する、相手先のメールサーバに送る、相手先のメールサーバはDNFから公開された公開鍵より認証を行う
###### DMARC
* 受信メールのFromヘッダーに記述されたメールアドレスのドメインのDNSサーバに登録されたDMARCレコードでは、DMARCポリシーより「何もしない、隔離、許可」をしている
## アドレス・名前解決
### DNS：Domain Name System
#### ホスト名やIPアドレスを集中的に管理する仕組み
##### FQDN：Fully Qualified Domain Name：完全修飾子
###### ホスト名．ドメイン名での表記
* 全角／半角及び大文字／小文字はすべて同じものとして扱う
##### IDN：Internationalized Domain Name：国際化ドメイン名
###### ドメイン名にアルファベットや数字以外の漢字やアラビア（Arabic）文字などを使えるように仕組み
* 同一の文字が複数の文字コードに対して、特定の文字を正規化を実施する
    * STRINGPREP：Preparation of Internationalized Strings
* 国際化ドメイン名にSTRINGPREPを適用するための規定
    * NAMEPREP：A String-prep Profile for Internationalized Domain Names
        * 変換アルゴリズムにはPunycode、ACEなどがある
##### 階層構造
###### ドメインの階層ごとに管理するDNSサーバが存在する
* 頂点にルートがあり、ルートサーバは世界に13個存在する．
* 頂点の次には第１レベルのドメインであるTLD（Top  Level Domain）があり、「jp」「com」、「org」「io」などが存在している
* ドメインごとにDNSサーバ（ホームサーバ）があり、それぞれのドメインを管理している、ドメインと同じようにDNSサーバも階層構造になっていて、じゅんに問い合わせを行う
###### 問い合わせ流れ
* 1．ローカルキャッシュ
* 2．DNSキャッシュサーバ
    * 3．ルートDNSサーバからTLD DNSサーバのアドレスを返却
    * 4．TLDに問い合わせ
        * ドメインの階層ごとに下のDNSサーバへ繰り返すで最終的にIPを取る
##### 主な資源レコード
###### A
* ホストのIPアドレス（IPv4）
###### AAAA
* ホストのIPアドレス（IPv6）
###### NS
* ネームサーバ
    * 先頭フィルードにドメイン名、データ部（RDATA）に正規のホスト名（FQDNも含む）を指定している
        * プライマリサーバ
            * DNSの情報の大元となる
        * セカンダリサーバ
            * 独自の情報追加ができない、プライマリの完全コピーの存在となる
        * ゾーン転送
            * セカンダリサーバが定期的にプライマリサーバへ問い合わせで、情報が更新されている場合にはコピーを行う
    * そのゾーン自身や下位ドメインに関するDNSサーバのホスト名を指定するレコードである
        * ゾーン分割を行ってサブドメインに権限委譲する場合は、サブドメインのネームサーバをNSレコードで指定する必要
###### CNAME
* ホスト別名に対する正式名
###### SOA
* 権威（登録データ）の開始
    * 他のDNSサーバのキャッシュ領域に情報を残す許可時間や、ゾーン情報の更新をチェックする間隔などを指定するレコードである
###### PTR
* IPアドレス逆引き用ポインタ
###### MX
* メールサーバのホスト名
    * 優先度をつけて複数設定を可能、値が小さいものが優先され
        * mail.xx.yy.zz IN MX 10 mail1
mail xx.yy.zz IN MX 20 mail2
###### TXT
* テキスト文字列
    * 例：DKIMはTXTレコードを使って、ドメインに対応する公開鍵を公開している
###### KEY
* セキュリティの鍵
###### 資源レコードの有効期間は、＄TTLのように秒数てされている
* 一部のレコードに対し、複数設定も可能
##### DNSラウンドロビン
###### DNSサーバ分散
###### 一ホスト名に対して複数のレコードを対応されるも可能です．DNSの問い合わせに対して順番 I Pアドレスを返すも可能
##### DNSサーバの種類
###### コンテンツサーバ
* DNSのレコードを保持し、他のサーバからの自ドメインへの問い合わせに答え
    * プライマリDNSサーバ
    * セカンダリDNSサーバ
###### フルリゾルバ（full-service resolver）／キャッシュサーバ
* クライアントからの問い合わせ結果に対して代理で問い合わせ、応答を行うフルリゾルバ
###### 一台のDNSサーバで兼ねるは可能が、セキュリティ上の理由から分けるが推奨されている
##### ポート番号
###### サーバ側はUDP53を利用する
* TCPフォールバック
    * DNSのレコード長512バイトを超える時など、UDPでの通信がうまくいかない場合には、TCPを利用することもある
* ゾーン転送では通常、TCPがポート番号53で用いられる
###### クライアント側以前は53番が使用されることが多いだが、現在は攻撃の特定を避けるためランダムにすることが多くなっている
### DHCP：Dynamic Host Configuration  Procotol
#### パケット流れ
##### １．DHCP発見パケット：DHCP DISCOVER
###### クライアントから、IPアドレスなどの設定情報を要求する、最初はDHCPサーバがどこにいるか分からないため、ブロードキャストでネットワーク全体に向けて送信
#####  2．DHCP提供パケット：DHCPOFFER
###### DHCPサーバが、提供できるIPアドレスなどの情報を設定し、ユニキャストで送信する
##### 3．DHCP要求パケット：DHCPREQUEST
###### クライアントから、DHCP提供パケットで受け取った情報ことを使用要求する
* ブロードキャストで送信する．目的は複数DHCPサーバ提供を受けた時に、他のDHCPサーバには要求しないことを同時に通知するのため
###### リース期間の半分の時間を経過すると端末から再度DHCPREQUESTで請求する
##### 4．DHCP確認応答パケット：DHCPPACK
###### DHCPサーバが、DHCP要求パケットに対する許可をユニキャスト方式で通知
#### 提供される情報
##### IPアドレスだけでなく、複数の情報を同時に提供はできる
###### サブネットマスク
###### デフォルトゲートウェイ
###### DNSサーバ
###### ホスト名
###### プリントサーバ
##### 情報の設定は、クライアントとサーバをDHCP対応が必要、かつ提供された情報にはリース期間され、DHCPクライアントんを延長した場合には、DHCPサーバに再度DHCP要求パケットを送信してリース期間の延長が必要となる
#### DHCPリレーエージェント
##### ルータを超えて別のネットワークとのDHCP通信が可能ある機制、DHCP RELAY  AGENTは通常ルータの機能持っている
###### DHCP RELAY AGENTは、自分が接続している区でDHCP発見パケットを受信したら、それをあらかじめ設定してあるDHCPサーバに向けてユニキャストで中継する、その応答に中継する
#### DHCPスヌーピング
##### サーバとクライアントの間でサーバとクライアントの間でやりとりされるDHCPメッセージを監視し、動的にIPパケットをフィルタリングする機能
###### DHCP SNOOPINGに対応した機器（スイッチなど）では、DHCPメッセージを監視することで、DHCPクライアントがどのポートのは以下に存在するのか追跡できる．そのポート情報を用いて、正規のDHCPサーバからIPアドレスが割り当てられた端末からの通信だけを通過させることにより、IPパケットのフィルタリングが可能なる
###### 主にセキュリティの視点で利用、DNSサーバなりすまし、IPアドレス悪意申請、DHCPサーバに対してのDoS攻撃など
#### DHCPv6
##### IPv6では、ICMPv6のルータ要求メッセージとルータ告知メッセージを利用してルータからIPアドレスお上位の上位ビットの情報を取得し、自分のMACアドレスあせてIPアドレスを自動に設定できる
###### DNSサーバやドメイン名など、IPアドレス以外の情報設定する場合に必要となる
## その他のプロトコル
### FTP：File Transfer Protocol
#### 制御用とデータ転送用の二つのTCPコネクションを利用
##### 通常流れ
###### Connect1→ USER ユーザ名, PASS パスワード
###### Connect1← 認証OK（230 User Logged in）
###### Connect1→ PORT IPアドレス、ポート番号
###### Connect1← ポートOK（220）
###### Connect1→ RETR ファイル名
* ほかSTOR、LIST、MV、COPYなど複数あり
###### Connect2←コネクション確立要求（150）
* サンプルのはアクティブモード、このモードでは、サーバ→クライアントからのコネクション確立、ファイアウォール・NATなどではサーバからクライアントへの通信を許可していないことが多い
###### Connect2→ ファイルデータ転送
###### Connect2← データコネクション終了（226）
###### Connect1→ QUIT
##### パッシブモード
###### PASVコマンドを利用することで、サーバ転送用のコネクションをクライアントからサーバへ確立する
### SNMP：Simple Network Management Procotol
#### TCP／IPネットワーク上でネットワーク管理を行うプロトコル、UDP上で動作する
##### マネージャ（管理用PCなど）
###### ネットワークを管理する側
##### エージェント（ルータ、スイッチ、サーバなど）
###### 管理される側
#### メッセージ／PDU
##### 動作チェック：Port 161
###### → get-request：参照要求
###### ← get-response：応答
###### → get-next-request：次の参照要求
###### ← get-response：応答
##### 設定変更：Port 161
###### → set-request：設定要求
###### ← get-response：応答
##### イベント通知：Port 162
###### ← trap：異常通知等
* エージェントから、予め閾値を設定しておいて異常な状態になった時にイベント通知を行う
    * snmpv2cでは到達確認があるinform-request
#### MIB：Management Information Base
##### SNMPでやり取りされる情報です．階層構造のデータベースで、データ構造の表記法であるASN．1（Abstract Syntax Notation 1）を利用した管理情報構造であるSMI（Structure of Management Information）を用いて記述される
###### 例：受信したすべてのオクテット数ifInOctets、IPアドレスに関するテーブルipAddrTableなど、エージェントで取得したり設定したり情報がMIBとして定義されている
* MIBには標準MIB、各メーカー独自の拡張MIBがある
#### コミュニティ
##### 監視対象をグループ化する概念です
#### RMON：Remote Network Monitoring
##### ネットワーク上のトラフィックやエラーなどに関する統計情報をRMONエージェントが収集し、RMONマネージャーが一元的に管理する機能
###### 単位はRMON MIBとして保存や転送
### IP電話
#### 電話網にVoIP（Voice over IP）技術を利用する電話サービス、音声を符号化してパケットに変換し、IPネットワーク上でリアルタイム伝送を行う
##### 呼制御
###### 電話機が行うような、通信相手を探して相手を呼び出すための仕組み
* H.323
    * ITUによって策定され、音声や映像を含むマルチメディアコンテンツをやり取りするためのプロトコル体系
        * IP
            * TCP
                * データ通信 #T #. #1 #2 #0
                * データ制御 #H #. #2 #4 #5 #, #Q #. #9 #3 #1 #, #R #A #S
            * UDP
                * RTP RTCP
                    * 音声
G.711
G.723
                    * 動画
H.261
H.263
        * H.323は元々、ISDN網とIPネットワークを接続するための規格として策定されていた．音声、動画やその他のデータにも対応するために多くの規格に準拠していて、その体系は複雑化している
* SIP：Session Initiation Procotol
    * H.323の後に開発された呼制御プロトコル．トランスポート層にはTCPだけでなくUDPも利用されている
        * 主なコマンド
            * REGISTER
                * IP電話の所在をレジストラ（レジスタサーバとも言う）に登録する
            * INVITE
                * セッション開始の呼びかけ
            * ACK
                * INVITEに関する応答の確認
            * CANCEL
            * BYE
                * セッションの終了
            * OPTIONS
                * 相手の通信能力などを問い合わせで利用
            * REFER
                * 拡張メソッド、別SIP URIへ呼を転送することを要求
            * NOTIFY
                * 拡張メソッド、要求されたイベントの通知、あるいは伝達を行う
            * SUBSCRIBE
            * MESSAGE
                * メッセージの転送
            * REFER→
202Accept←
NOTIFY←
200OK→
BYE→
200OK←
INVITE←←別の端末
        * 主な応答メッセージ
            * 100
                * Trying
            * 180
                * Ringing
            * 200
                * OK
        * 呼制御流れ
            * 
    * SIPはHTTPを元にした単純なプロトコルです、他のプロトコルと組み合わせて使用する
        * 組み合わせ例
            * SDP：Session Description Procotol
                * メディアの種類、使用するプロトコルやポート番号など、セッションに必要な情報交換を行うためのメッセージ記述言語
            * ENUM：E.164 Number to URI Mapping
                * 電話番号とURIの対応つけを行うENUM（Telephone Number Mapping）という技術が開発されたが、ほとんど普及されな易
    * SIPサーバ
        * 機能構成より
            * プロキシサーバ
                * 発信者と着信者間において、SIPセッションの確立を行うためSIPリクエストを中継するサーバ
                    * 中継ではサーバとしてもクライアントとしても動作している
            * リダイレクトサーバ
                * 要求URIをロケーションサービスに問い合わせた時、新しいSIP URIなどが回答されると、プロキシとして動作するのではなく、3xxのリダイレクトをクライアントに返答する機能
            * レジストラ（レジスタサーバ）
                * REGISTERを受付、ロケーションサービスにその内容を登録するサーバ
            * ロケーションサービス
                * URIとIPアドレス（或いは転送先などの新しいURI）を対応つけるデータベースのこと
* その他
    * IP電話では、SIPサーバがエンドーエンド間で呼を確立させると、音声通信にはは、一般に電話機同士の間で直接行われ
        * ただ、外部ネットワーク環境むけに、社外にはIP-PBX経由（その場合、IP-PBXをSIPサーバの役割を担っている）
    * 課金なら、時間の記録が必要となるSIPサーバをコールステートフルプロキシと呼ぶ
    * 課金ではなく、単にメッセージの中継だけを行い、状態を管理しないSIPサーバをステートレスプロキシと呼ぶ
##### RTP：Real-Time Transport Protocol
###### 音声や動画などのデータ本体を送るためのプロトコル
* UDPを利用、パケットにシーケンス番号をつけてパケットの順番を並べ直し、パケットの抜けを確認する。パケットのタイムスタンプ（送信時刻）の管理も行う
    * UDPの欠点に対して、暗号化プロトコルSRTPをRFC 3711として規定している
    * 鍵交換も、RFC4347でDTLS（Datagram Transport Layer Security）を利用している
    * RFC 5763：DLTS-SRTP Framework
    * RFC 5764：DTLS Extension for SRTP
##### RTCP：RT Control Procotol
###### RTPを補助するためのもの、送信バイト数、パケットの欠落数やパケットの到着間隔のばらつきなどの統計情報を集め、その情報をアプリなどに提供することでQoS（Quality of Service）の確保に役立つ
##### 優先制御
###### ルータで制御する、ポート番号あるいはTOS（或いはDS：DiffServ）フィールドの値などを見て制御
* アルゴリズム
    * キューイング
    * パケットキューイング
    * 主なキュー制御方法
        * WFQ：Weighted Fair Queuing
        * CBQ：Class Based Queuing
        *  PQ：Priority Queuing
##### 帯域制御
###### 例：音声帯域とデータ帯域を分け、音声帯域を優先的に転送
##### IPパケットレベルでは、TOS（DS）フィールドなどによって、優先制御が実施され．ただ、IP−VPNや広域イーサネット内では、IPヘッダーが見えないため、MPLSヘッダーのEXP（3ビット）フィールドによって、または広域イーサネットでは通信事業者が独自に付加するVLANタグのプライオリティ（3ビット）によって、優先制御を行う．なお、VLANタグのプライオリティビットは、CoS（Class of Service）ビットと呼ばれることがある
#### 構成
##### 例
###### SIPサーバは、IP電話機同士の呼制御を行うサーバであり、呼制御を行われた後は、基本的にIP電話機同士で通信を行う
#### 品質
##### 正常な通話を確保するために音声の品質が重要です、代表的なIP電話の音声品質を示す指標がも蹴られている
###### MOS：Mean Opinion Score
* 主観的な手法です、評価者に電話機から音を聴かせて5段階で評価させ、この値の平均を取ったものがMOS値です
###### R値
* ITU−T G.107で標準化されている、ノイズの影響を考慮した信号の大きさ、エコーや遅延などに劣化などから算出している
    * 全部で18個のパラメータから算出、Ro - Ls - ld - le + A．R値が高い程通信品質が良くとされ
        * ※日本では、050で始まる電話番号を取得するには、R値が50より大きい必要がある
###### PSQM：Perceptual Speech Quality Measure
* 音声符号化方式の客観評価手法、原音声と劣化音声を比較して劣化の度合いを計算し、数値化する
###### PESQ：Perceptual Evaluation of Speech Quality
* PSQMの改良版、パケット損失などに対応している
###### そのた
* ジッタ（揺らぎ）
    * 音声の乱れの一因で、パケットの伝送時間が一定しない状況です
### コンテンツ配信
#### インターネットで音声・動画などのコンテンツをリアルタイムで配信するためのマルチメディア通信向けのプロトコルや規格
##### RSVP：Resource reSerVation Procotol
###### ネットワーク上で送信元から送信先までの帯域を予約し、通信品質を確保する
* テレビ会議やリアルタイムでの動画配信など、即時性が求められるトラフィックを優先制御する仕組み
    * 実現技術
        * IntServ
            * エンドツーエンドで細かい優先制御を行う
                * 特定のアプリケーション間の通信において、必要な時に経路上のルータに対して品質制御の設定を行う
                * フローセットアップ
                    * パケットを受信側から送信する側に向けて制御パケットを流し、その間に存在するそれぞれのルータに品質制御のための設定を行う
        * DiffServ
            * IntServと相対的に大まかな優先制御を行う
                * 特定のネットワーク内でそれぞれのパケットをラック付けし、パケットに対して優先制御を行う
                    * IPヘッダのTOSフィールド（DSCPフィールド）を用いて優先度を設定するもので、IP電話などで良く利用される
### 音声圧縮処理
#### A／D変換（PCM：G.711）後、データ容量が大きいので、一般的には圧縮する
##### MP3：MPEG Audio Layer−3
###### 動画の圧縮規格であるMPEG−1のオーディオ規格として開発され、非可逆圧縮の音声圧縮方式
##### CS-ACELP：Conjugate-Structure Algebraic Code Excited Linear Prediction
###### CELP（符号励振線型予測）を用いた圧縮手法．単純な音源ではなく、データベースとして用意下固定音源と、過去に用いた音源である適応音源の二つ組み合わせて音声を作成し、携帯電話やVoIPで良く利用される圧縮形式．G.729で標準化、8kビット／秒に圧縮できる
### 動画圧縮処理
#### 代表例
##### MPEG−1
###### 1.5Mビット／秒程度の圧縮方式で、CD−ROMなどを対象にしたもの
##### MPEG−2
###### 数M〜数十Mビット／秒の圧縮方式で、DVDやBlu-rayなどを対象としたもの
##### MPEG-4
###### 数十k〜数百kビット／秒程度の低ビットレートの圧縮方式で、携帯モバイル機器を対象としたもの
##### MPEG-7
###### マルチメディア用のパラメータ表記方法の国際規格で、XMLで記述され
### 動画・音声配信の方式
#### ダウンロード配信
#### ストリーミング配信
### ピアツーピア：P2P：Peer to Peer
#### 対等のもの（ピア）同士が通信を行う方式
##### P2Pの通信網では、「キー」を手がかりに「キーに対応するデータを持つもの」を発見して、その相手都通信する．その「キー」と「データ」をペアで結びつける情報はインデックス（Key−Value）です
### そのた
#### IGMP：Internet Group Management  Procotol
##### マルチキャストによる通信において、通信を管理するためのプロトコル
###### IPv4→IGMP
###### IPv6→存在しない、ICMPv6の機能の一つである M LD（Multicast  Listener Discovery）が使用
##### 主な役割
###### 最寄りのルータにマルチキャストグループに参加したいと伝えるために、受信したいマルチキャストアドレスを通知する
* マルチキャストパケットの経路は、PIM（Protocol-Independent Multicast）などのマルチキャスト用のルーティングプロトコルが利用され
###### IGMPスヌーピングに対応したスイッチングハブに、ルータに通知した受信したいマルチキャストアドレスを通知する
* 対応しないスイッチは単純のブロードキャストになり、ネットワーク負担が上がる
#### NTP：Network Time Procotol
##### UTC（Universal Time Coordinated：協定世界時）を使って時刻を送受信する
###### stratumと呼ばれる階層構造を用い、stratum0が原子時計やGPSなどの正確な時刻源です．→stratum1→stratum2．．．
* 複数のネットワークを持つネットワークでは、上位NTPサーバの負荷軽減やネットワーク内の誤差を減らすために、構成上なるべく近いサーバから情報を取得することが推奨されている
* NTPサーバを複数設定し、可用性を高まる可能
* NTPサーバから各機器に時刻値を問い合わせてそれが到達するまでの通信時間を考慮し、通信時間による時刻の誤差を小さくする工夫がなされている
#### LDAP：Lightweight Directory Access Procotol
##### ディレクトリサービスにアクセスするためのプロトコル．DSとは、ネットワーク上の資源の管理サービスで、ネットワークをりようすると利用者や機器などの資源に関する情報を一元管理する
##### LDIF：LDAP Interchange format
###### 設定情報のデータ交換形式です、これを使ってディレクトリツリーという形で階層的に管理する
* ルートDSE（Directory Service  Entry）は、各ディレクトリサービス起点（エントリー）です
##### TCP：389が使っている
