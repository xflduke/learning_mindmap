# ＮＷ：０２_インターネット層
## IPとは
### ネットワークとは
#### OSI基本参照モデルのネットワーク層で接続される、ルータで分けられた範囲がネットワークです
##### OSI基本参照モデルのデータリンク層が同じ部分が、ひとつのネットワークとなる、ブロードキャスドメイン＝ネットワークという位置ツケとも言える
### データリンクとの違い
#### 例（注意：データリンクヘッダがデータリンクが変わるごとに毎回付け替える）
### IPの役割
#### IPアドレスでの識別
##### ネットワークに接続されているすべてのホスト内、通信を行うホストを見つけるために使用される
#### 経路制御（ルーティング）
##### 宛先ホストまでパケットを届けるため、パケットを順番に転送するための仕組みです．ここのルータが宛先IPアドレスをチェックして、次に転送を行うルータを決定する
#### IPパケットの分割と再構築
##### データリンクごとに異なる最大転送単位（MTU）に合わせてパケットを分割する、分割されたパケットは、宛先のホスト出ひとつにまとめられる．
### IPヘッダ
#### バージョン：Version
##### 4ビット：2021現在では4、6がほとんど
#### ヘッダ長：IHL：Internet Header Length
##### 4ビット：IPヘッダの大きさを表す、単位は4バイトで、オプションなしのIPパケットの場合は5（4バイト✖️5＝20バイト）
#### サービスタイプ：TOS：Type Of Service
##### 8ビット：IPサービスの品質を表す、通信パケットの優先度の制御する．
###### DSCP（Differentiated Services  Code Point）フィールドとECN（Explicit Congestion  Notification）フィールドとして再定義されている．ECNはネットワークの輻輳通知で、DSCPはDiffServと呼ばれる品質制御で利用される
#### パケット長：Total Length
##### 16ビット：パケット全体（IPヘッダ＋データ）のオクテット長
#### 識別子：ID：Identification
##### 16ビット：フラグメント（分割パケット）を復元する識別子です
#### フラグ：Flags
##### 3ビット：パケットの分割に関する制御を指示するフラグ
#### フラグメントオフセット：FO：Fragment Offset
##### 13ビット：フラグメントが基データのどのに合ったかを示す
#### 生存時間：TTL：Time To Live
##### 8ビット：中継できるルータの個数を示す、ルータを通過すること度に一つずつ減らし、0になったらパケットを破棄する
#### プロトコル：Protocol
##### 8ビット：IPヘッダの次のヘッダのプロトコルを示す
###### 代表例
* 1：ICMP
* 6：TCP
* 17：UDP
* 41：IPv6
* 50：ESP
* 51：AH
* 112：VRRP
#### ヘッダチェックサム：Header Checksum
##### 16ビット：IPヘッダが壊れていないかどうか確認するための誤り検出符号
#### 送信元IPアドレス：Source Address
##### 16ビット
#### 宛先IPアドレス：Destination Address
##### 16ビット
#### オプション：Options
##### 可変長
#### パディング：Padding
##### オプションを32ビットの倍数にするための詰め物
#### データ：Data
##### 上位層のヘッダも含めたデータ
#### IPv6では拡張され、128ビットになり
### 用語
#### データグラム
##### ネットワーク層までのデータが格納されたパケット
#### フレーム
##### データリンク層まで含んだ、実際の通信経路を流れるパケット
## IPアドレス
### IPv4仕組み
#### 32ビットを8ビットずつの四つの組にわけて10進数に直し、その境目にピリオドを入れることで表現する
##### IPアドレスはホストごとではなくNICごとに割り振られる．また、ルータは二つ以上のネットワークを接続する機器なので、ネットワーク後と、つまり、ルータのポートごとにIPアドレスを持っている
### IPアドレス構成
#### ネットワークアドレス
##### ネットワークごとに割り当てられるアドレス、同じデータリンクには同じネットワークアドレス、異なるデータリンクには異なるネットワークアドレス
###### ルータはネットワークアドレスを基に、パケットを適切なネットワークに転送する
* ルータなどでネットワークアドレスを記述する場合には、ホストアドレスの部分のビットはすべて0にすることで実現する
* ホストアドレス
    * IPアドレス中、ネットワークアドレス以外の部分
#### クラス
##### クラスA
###### 8ビット #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
###### 24ビット #ホ #ス #ト #ア #ド #レ #ス
###### 0 #先 #頭 #ビ #ッ #ト
###### 0.0.0.0~127.0.0.0 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス #範 #囲
######  #備 #考
###### 10.0.0.0--10.255.255.255 #プ #ラ #イ #ベ #ー #ト #保 #留 #部 #分 #（ #こ #の #部 #分 #は #公 #開 #申 #請 #で #き #な #い #、 #か #つ #グ #ロ #ー #バ #ル #I #P #の #よ #う #な #ル #ー #テ #ィ #ン #グ #さ #れ #な #い #）
##### クラスB
###### 16ビット #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
###### 16ビット #ホ #ス #ト #ア #ド #レ #ス
###### 10 #先 #頭 #ビ #ッ #ト
###### 128.0.0.0~191.255.0.0 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス #範 #囲
###### 172.16.0.0--172.31.255.255  #プ #ラ #イ #ベ #ー #ト #保 #留 #部 #分 #（ #こ #の #部 #分 #は #公 #開 #申 #請 #で #き #な #い #、 #か #つ #グ #ロ #ー #バ #ル #I #P #の #よ #う #な #ル #ー #テ #ィ #ン #グ #さ #れ #な #い #）
##### クラスC
###### 24ビット #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
###### 8ビット #ホ #ス #ト #ア #ド #レ #ス
###### 110 #先 #頭 #ビ #ッ #ト
###### 192.0.0.0~223.255.255.0 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス #範 #囲
###### 192.168.0.0--192.168.255.255 #プ #ラ #イ #ベ #ー #ト #保 #留 #部 #分 #（ #こ #の #部 #分 #は #公 #開 #申 #請 #で #き #な #い #、 #か #つ #グ #ロ #ー #バ #ル #I #P #の #よ #う #な #ル #ー #テ #ィ #ン #グ #さ #れ #な #い #）
##### クラスD
###### 32ビット #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
###### なし #ホ #ス #ト #ア #ド #レ #ス
###### 1110 #先 #頭 #ビ #ッ #ト
###### 224.0.0.0~239.255.255.255 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス #範 #囲
###### IPマルチキャスト用、ホストアドレス部分はない、マルチキャスト通信は、音声や映像データを一斎放送するために、マルチメディアアプリケーションなどが使用する #備 #考
##### クラスE
###### 1111 #先 #頭 #ビ #ッ #ト
###### 32ビット #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
###### なし #ホ #ス #ト #ア #ド #レ #ス
###### 240.0.0.0~255.255.255.255 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス #範 #囲
###### 実験用としてTCP/IP（IPv4）の開発当初から予約されている、実際に使われることはない #備 #考
#### 保留IPアドレス
##### クラスの中に、ホストアドレスのすべてのビットが0のアドレスは、ネットワークアドレスそのものを表す．すべてのビットが1のアドレスはブロードキャストアドレスとして使われている
###### ブロードキャストアドレス：同じネットワークの全てのホストにパケットを送信するためのアドレス
##### クラスの中に割り当てられるアドレスは保留分の二つを除いた部分
#### サブネットワーク
##### クラスをさらに分割するために、ホストアドレスの一部をサブネットワークアドレスとして使う
###### この場合のネットワークアドレスはクラス固有のネットワークアドレス＋拡張されたサブネットワークとなる
* ←CIDR表記法がわかればこの段落の説明を無視でいい、この部分は無駄な概念を作っている　
#### スーパネットワーク
##### 複数のクラスを統合して一つのネットワークにすること
#### VLSM：Variable Length Subnet  Mask
##### サブネットごとにネットワークを変えられる仕組み
##### CIDR：Classless Inter−Domain  Routing
###### 可変長のネットワークアドレスの部分を、IPアドレスの後ろに“／”を付け、その後にプレフィックスと呼ばれるネットワークアドレスのビット数を示すこと
* 例：172.16.215.133/26
    * ネットワークアドレス26ビット、ホストアドレス6ビット、ネットワーク中に割当てるアドレス数62
###### IPアドレスを有効利用できるだけでなく、経路情報を集約することも可能になる
###### アドレス集約
* 複数のネットワークアドレスを集約できる、ルーティングを行う際、複数のネットワークアドレス（複数のクラス）を一つに集約することによって経路情報を減らすことが可能
#### 通信相手の数
##### ユニキャスト
###### 相手をひとつのホストに限定した１対１の通信
##### ブロードキャスト
###### 同じネットワーク内のすべてのホストを相手にした全員向けの通信
##### マルチキャスト
###### クラスDのIPアドレスを使用、必要としているグループのみにパケットを送信する
* マルチキャストIPアドレス　
    * 224.0.0.0~224.0.0.225
        * リンクローカル：同じリンク内のみでのマルチキャストとなり、通常TTL値「1」で送信され、ルータで中継されない
            * Well-Known
                * 224.0.0.1
                    * サブネット内のすべてのシステム
                * 224.0.0.2
                    * サブネット内のすべてのルータ
                * 224.0.0.5
                    * OSPFルータ
                        * OSPF（Open Shortest Path First）は、TCP/IPのIGP（Interior Gateway Protocol）として使用される、LINK stateアルゴリズムをもつ、ダイナミックルーティングプロトコルです。
                * 224.0.0.6
                    * OSPF指名ルータ
                * 224.0.0.9
                    * RIP2ルータ
                        * Route Infomation Procotol：経路選択（ルーティング）に「ディスタンスベクタ型」（距離ベクトル型）と呼ばれる方式を用いる。隣接するルータ間でルーティングテーブル（経路表）を交換し合い、どの隣接ルータを経由すれば最短のホップ数（中継機器を通過する回数）で宛先に届くかを基準に経路を指定する。
                * 224.0.0.12
                    * DHCPサーバ／リレーエージェント
                * 224.0.0.18
                    * 全てのVRRPルータ
    * 224.0.1.0~238.255.255.255
        * グローバルスコープ：全ネットワークグループのメンバーに到達する
            * Well-Known
                * 224.0.1.1
                    * NTP：Network Time Procotol
    * 239.0.0.0~239.255.255.255
        * プライペートスコープ：管理もしくは限定的に利用され
* マルチキャストMACアドレス
    * ユニキャストの場合は、ARPで取得したMACアドレス
    * ブロードキャストの場合は、「ffff.ffff.ffff」と言うMACアドレスを宛先 MACアドレスとして使う
    * マルチキャストの場合、アドレスの先頭オクテットの第6ビットと第7ビット（イーサネットではアドレスを読み込む際オクテットのうしろから読み込むため、その観点で言えば第0ビットと第1ビット）でキャストが決める
        * 第0ビット
            * 0：ユニキャスト
            * 1：ブロード／マルチキャスト
        * 第1ビット
            * 0：グローバルアドレス（ユニ／マルチキャスト）
            * 1：ローカルアドレス（ブロードキャスト）
    * IANA：Internet Assigned Numbers  Authorityでの規定
        * MACアドレスは先頭の25ビットが固定値
            * 0100.5e00.0000~0100.5e7f.ffff
* 流れ
    * [IPマルチキャスト](https://ja.wikipedia.org/wiki/IPマルチキャスト)
    * IGMP join／leaveよりグループに追加や退出
    * マルチキャストを配信する経路を作成するプロトコルとして、一般的にPIM（Procotol  Independent Multicast）が利用され
        * PIMーDM（Dense  Mode）
            * 全てのルータにマルチキャストパケットを配信し、その後、不要な配信経路を削除する方式
        * PIMーSM（Sparse Mode）
            * RP（ランデブーポイント）と呼ばれるルータをあらかじめ決めておき、最初はこのRPを経由してマルチキャストパケットを配信する
            * RPのIPアドレスには、IPエニーキャストアドレスが使用され
    * RPF（Reverse Path Forwarding）チェック、マルチキャストパケットがその配信途中でループしたり、同じパケットが重複してシーバに届いてしまったりしないようにチェックする仕組み
        * 受信したマルチキャストパケットの送信元IPを見て、そのパケットがマルチキャストソース（配信サーバ）から最短経路で転送されてきたものかどうか
* 対応関係
    * マルチキャストIPアドレスの後ろから23ビットを，MACアドレスの固定値以外の後半23ビットに入れることにより対応させ
        * クラスDの先頭の1110を除いて、IPアドレスの5ビットはMACアドレスに未対応＝ひとつマルチキャストMACアドレスは最大32個のIPアドレスを対応している
#### ルーティング
##### IPアドレスを基に、ルーティングテーブル（経路制御表）を参照し、パケットの送信先、転送先を決める
###### 次のルータのネットワークアドレスが複数あるの場合、プレフィックスが長い方を選定する
* 例：次のルータに以下の二つある場合
 172.16.10.0/16 と 172.16.10.0/24
    * 172.16.10.0/24へ転送する
#### デフォルトゲートウェイ
##### 全てのネットワークやサブネットについての情報をルーティングテーブルに掲載すると、情報量が多くなりすぎ、そのため、ルーティングテーブルに登録されていないIPアドレスの場合の転送先としてデフォルトルートが設定されている
###### デフォルトルートは0.0.0.0/0またはdefaultに記述している
* 例：dest 0.0.0.0 mask 255.255.255.0 gw 192.168.1.1
#### グローバルアドレス
##### インターネットに接続するルータにおいて、プライベートアドレスと、インターネットで利用可能なグローバルアドレスを変換している（NAT）
##### ICANN：The Internet Corporation for  Assigned Names and Numbers
###### グローバルIPだけでなく、ネットワークを識別する名前であるドメイン名も、ICANNが管理している
###### 下部組織のIANA：Internet Assigned Numbers  Authority
* 実際にIPアドレスを割り振っている組織
    * 2011/02/03 IPv4アドレスの在庫が枯渇した
* 日本ではアジア太平洋地域のAPNIC（Asia  Pacific Network Information Center）に含まれ
    * 日本の割当機関JPNICが、ISPにIPアドレスを割り当てる、通常の割当歯すでに終了した．
### IPv6
#### 表記
##### 128ビットのIPアドレスを16ビットごとに区切り、それをコロン（:）で区切って16進数で表す、さらに、0が続く場合には0を省略し、コロンを２つ続けて（::）表すことができる←この省略表現は一アドレスに1箇所に限られ
###### 例：FD80::8AFE
* FD80:0:0:0:0:8AFE
##### 分類
###### 未指定アドレス
* 0::0 #先 #頭 #ビ #ッ #ト
* ::/128 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* まだIPアドレスが割り当てられていないことを示すためのアドレス #解 #説
###### ループバックアドレス
* 0::1 #先 #頭 #ビ #ッ #ト
* ::1/128 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* IPv4の127.0.0.1と同様、自分自身を表すIPアドレス #解 #説
###### ユニークローカルアドレス
* 1111 110 #先 #頭 #ビ #ッ #ト
* FC00::/7 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* インターネットとの通信を行わない場合に使用する、ルータで中継されですが、企業内ネットワークなど、特定のネットワーク内のみでの使用を想定している #解 #説
    * フォーマット：
        * 先頭7ビット＋1ビット（0保留中、1利用中）＋グローバルID40ビット＋サブネットワークID16ビット＋インタフェースID64ビット
            * ネットワークを統合しても重ならないように、グローバルIDをランダムに決定して、できるだけ一意なアドレスとなるようにする必要がある
###### リンクローカルユニキャストアドレス
* 1111 1110 10 #先 #頭 #ビ #ッ #ト
* FE80::/10 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* 同じデータリンク内でののみ使えるアドレス、ルータでは中継されない、先頭10ビット＋54ビットの0＋インタフェースIDの形式です #解 #説
###### マルチキャストアドレス
* 1111 1111 #先 #頭 #ビ #ッ #ト
* FF00::/8 #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* 複数ノート向けて送信用、IPv4のブロードキャストアドレスのような役割を持つマルチキャストアドレスにオールノードマルチキャストアドレスがある（FF02::1） #解 #説
###### グローバルユニキャストアドレス
* その他すべて #先 #頭 #ビ #ッ #ト
* その他すべて #ネ #ッ #ト #ワ #ー #ク #ア #ド #レ #ス
* 現在のIPv6フォーマットでは、ネットワークアドレス（広域ネットワーク／グローバルルーティングプレフィックスの48ビット＋サブネットIDの16ビット）とホストネットワーク（インタフェースID識別子の64ビット）で構成され #解 #説
    * インタフェースID識別子は通常、64ビット版のMACアドレスが格納されている．MACアドレスを通信相手に知られたくない時には、一時アドレスをランダムに生成することもある
        * 64ビットMACアドレス：IEEEではEUI−64で定義され、通常の48ビットのMACアドレスから自動変換できる
            * 48ビット版のMACアドレスを24ビットごとに分け、その真ん中に、16進数でFFFEとなるビットを入れる、そして、高位第一目バイトの第7ビット目のU／Gビットを反転させて完成
##### エニーキャストアドレス
###### 複数のノードのインターフェースに割り当てた同一のIPアドレスのことです。複数のノードで同じIPアドレスを共有することになり、送信元ノードからエニーキャストアドレスに対してパケットを送信した場合は、このエニーキャストアドレスを持つ最も近いノードへパケットが転送される
#### IPv4との共存技術
##### トンネリング
###### IPv4ネットワーク上でIPv6パケットをルーティングするための方式
* ルート間で自動トンネリングを行う6to4 や　ローカルIPv4ネットワークでIPv6通信を実現するTeredoやISATAPなど技術がある
    * 6to4：RFC3056
        * IPv4のグローバルアドレスに対して、ユニークなIPv6アドレスを割り当てて、IPv4ネットワークを通じてカプセルかしたIPv6パケットを転送する、2002:<IPv4アドレス>::/48の形で割り当てる
            * IPv6のカプセル化および解除は6to4をサポートするルータなどが必要
    * ISATAP：Intra-Site Auto magic Tunnel Addressing Procotol：RFC 4214
        * ::5EFE:<IPv4アドレス>、この方法を用いて、リンクローカルユニキャストアドレスが作られる
            * 6to4と同様に、ISATAPをサポートするルータが必要
##### デュアルスタッフ
###### 単一機器にIPv4とIPv6の二つの異なるプロトコールスタッフを同時に動作させ、共存する仕組み
* 旧環境を残しつつIPv6に対応させることが可能、IPv6への移行がしやすく
    * ただ、NIC複数化や相応の計算力とDNS（AレコードとAAAAレコード→NSレコードを利用して両方を一回で取れる可能）が複雑になり
##### IPv4／IPv6トランスレーション
###### Proxy方式
* アプリケーションごとに送信元の代理となるトランスレータが通信を行う
###### NAT−PT方式
* アドレスやポート番号を変換することで相互に通信する
###### TCP Relay方式
* トランスポート層でセッションを横取りし、自身が代理となってTCPやUDPでの通信を中継する
###### IPv4しか利用できないホストとIPv6しか利用できないホスト間通信ための技術
#### 特徴
##### IPアドレスが128ビットになり、2021の予想で事実上無上限
##### ルータの負荷を軽減
###### IPヘッダ長を固定で40オクテットとし、ルータでの分割処理やチェックサムをなくすことで負荷軽減できる
##### プラグ＆プレイ機能
###### DHCPサーバがなくても、IPアドレスを自動的に割当てることができる
##### セキュリティ機能（IPSec）
###### 認証機能や暗号化機能、なりすまし防止策などを提供するセキュリティ機能であるIPSecを標準でサポートする
* 2020年までのIPv6では、IPsecのサポートは必須ではない
    * 以前のRFC4294では必須としたが、RFC6434では推奨になった
##### ルーティングテーブルの集約
###### IPアドレスをISPごとに大きく割り当て、ISPがそれを細かくして計画的に配布することによって、ルーティングテーブルがあまり大きくならないようになれる
## モバイルIP
### ホストが接続しているネットワークが変わっても、IPアドレスが変わらないようにする仕組み、移動するホストで通信を継続させることができ手法
#### 仕組み
##### 概念
###### 移動ホスト：MH：Mobile Host
* ノートPCやスマホなどの移動するホストのこと
###### ホームネットワーク：HN：Home Network
* 移動ホストが移動しない時に使用する、本来稼働すべきネットワーク、移動ホストはホームアドレスと呼ばれるIPアドレスが持っている
###### ホームエージェント：HA：Home Agent
* ホームネットワークが設定され、移動ホスト都通信相手のホストとの通信を仲介する設備
###### 外部エージェント：FA：Foreign Agent
* 移動先のネットワークには、移動ホストをサポートするための設備、ホームエージェントとの間でトンネリング通信を行い
    * 外部エージェントは、移動ホストが移動する可能性があるすべてのネットワークが必要です
##### MHは、FAが送出するAdvertisement（広告）メッセージを受信
###### →自分がどのネットワークにいるかを判別
* →HN以外への移動を検出すると、MHがFAに対して自身のホームアドレスを通知
    * →FAは、そのアドレスと気付アドレス（転送先のIPアドレス、外部エージェントのIPアドレスでもある）をHAに通知
        * これにより、MHへの通信を気付アドレスに転送し、通信を継続させることが可能になる
## ルーティング
### ルータ
#### ルーティングテーブルを参照してパケットをルーティングする機器
##### 主な機能
###### 異なるネットワークの接続
* 例：家庭用のブロードバンドルータでは、家庭内のイーサネットとFTTHなどの通信業者のWANサービスと中継する
###### IPパケットの転送
* ルーティングテーブルを参照し、適切なネットワークにIPパケットを転送する
###### IPパケットの選別
* パケットフィルタリング機能を用いて不適切なパケットを破棄したり、QoS機能を用いて、優先して転送するパケットを区別したりです
###### ルーティングテーブルの管理
* 最新化など
###### NAT／NAPT／NAT−PT、DHCP、アクセスポイントなど
#### ルーティング
##### スタティクルーティング
###### 静的（手動）で固定的にルーティングテーブルを設定する方法
##### ダイナミックルーティング
###### 動的（自動）にルーティングテーブルを作成している
* ルーティングプロトコルを動作させ、他のルータからルーティングに必要な情報を取得する
#### デフォルトルート
##### どの経路にもマッチしない場合の経路としてデフォルトルートを設定、0.0.0.0/0またはdefaultと設定する
#### ホストルート（静的手動設定ルート）
##### 特定のホスト、一つのIPアドレスだけを特別にルーティングしたい時には利用
#### ルーティングプロトコル
##### ルータ同士で自分が知っているネットワーク情報を教え合うことによって、ルーティングテーブルを作成している、教え合う方法には様々なルーティングプロコトルがある
###### 経路制御範囲
* ルーティングポリシを決めて、それを適用して運用する範囲をAS（Autonomous System：自律システム）と言う
    * 例：ISPや地域ネットワーク、ASの内で利用されるルーティングプロトコルがIGP（Interior  Gateway Protocol）です、AS間の経路制御に利用されるのがEGP（Exterior  Gateway Protocol）です．
###### 経路制御アルゴリズム
* 距離ベクトル型
    * 距離（メトリック）と方向によって目的ネットワークへの経路を決定する方法、距離は通過するルータの数（ホップ数）で計算
        * 簡単に設定できるが、安定するまでに時間がかかる、また、経路にループが生じ安くなるなどの問題がある
            * 例
                * RIP
                * RIP2
                * 適用範囲：IGP
UDPを利用して実現
* リンク状態型
    * ルータがネットワーク全体のリンク状態を理解してルーティングテーブルを作成する方法、各ルータが対象範囲内のすべてのルータに関する情報をもち、各ルータの情報が同じになれば、正しい経路制御が行われる
        * ルータの設定やリンク状態の計算が複雑なので、ルータにCPUとメモリ資源が必要
            * 例
                * OSPF
                    * 適用範囲：IGP
 IPを利用して実現
                * IS-IS（Intermediate System - Intermediate System）
* 経路ベクトル型
    * それぞれのルータが到達可能なネットワークのエントリに加えて、各ネットワークまでの経路情報（ASの並び、ASパス）を保持します。経路情報がASの並びであるとすると、そこから経由するASの数（距離）を算出することができる
        * 例
            * BGP
                * 適用範囲：EGP
 TCPを利用して実現
##### プロトコル代表例
###### RIP：Routing Information Protocol
* LANで最も広く利用されているルーティングプロトコルです、距離ベクトル型であり、ホップ数（ルータの数）を用いて、選択する経路を決定する
    * 仕組み
        * ルーティングテーブル構築
            * ルータが自分の知っている経路制御情報を３０秒ごとにネットワーク上ブロードキャストする、そして、他のルータから受け取った経路情報は、距離に１を足してから、次の機会にブロードキャストする
                * それで、各ネットワークに対して最も距離が小さい経路を抜き出すと、ルーティングテーブルが完成
        * 障害対応
            * さらに、パケットが６回（180秒）着なかった場合には、接続が切れたと判断し、距離ベクトルデータベースから該当する情報を削除する．また、パケットがループし続けないよう、ホップの最大数は15とし、これを越えた場合には破棄する
        * 経路変更を加速方法
            * ルートポイズニング
                * 経路が切れたと判断した時、その情報を流さないのではなく、通信不能を示す距離16を流すことで障害を伝える
            * ポイズンリバース
                * 到達不能な経路情報を受信した場合、その経路情報をそのまま同じインタフェースから隣接ルータに通知する
            * トリガードアップデート
                * 経路が変化した時、３０秒を待たずにすぐに次のルータに伝搬する
        * ループ防止
            * ループのはルータ間情報交換でのループ、接続自体のループではない
                * 通信不能を示す広告は別のルータの情報より上書きされることで、この二つルータの間に、通信不能ルータ宛の情報があれば無限ループになる
            * スプリットホライズン
                * 他のルータからもらったルート情報は、その情報をくれたルータには広告しない
            * イベント・トリガー・アップデート
###### RIP2
* 改善点
    * サブネットマスク対応
        * RIPではクラスのみ判断している、RIP2ではサブネットマスクを対応し、可変長のネットワークアドレスをルーティングできるようになった
    * マルチキャスト使用
        * RIPのパケットをブロードキャストではなくマルチキャストで送ることで、トラフィックを軽減させる
    * 認証
        * 自分が認識できるパスワードを持っているRIPパケットのみを受容し、他を無視すると言う認証の仕組みが使えるようになった
###### OSPF：Open Shortest Path First
* ネットワークのリンク状態を全てのルータで共有することにより、ループがあるネットワークでも安定した経路制御を可能にする
    * 各リンクに重み（コスト）をつけて、最優経路を選択する
        * 指名ルータ
            * すべてのルータ間で経路情報が交換するわけではなく、指名ルータを中心に経路制御情報が交換する
        * エリアとバックボーンエリアとエリア境界ルータ
            * トポロジーの情報が大きいすぎを防ぐため、エリアと言うグループに分けて管理する．
                * エリア（エリアN（N＞0））は必ずバックボーンエリアに接続され、バックボーンエリア（エリア0）と各エリアの境界にあるルータがエリア境界ルータです．
                * エリア境界ルータはエリアNとエリア0両方にいる．エリアNの内エリア境界ルータ以外のルータはエリア内のトポロジー情報だけを持つ、エリア外に関して、エリア境界ルータからの距離しかわかりません
    * RIP2との共通点
        * 可変長サブネットマスクが対応している
        * ルーティング情報の更新にマルチキャストを使用している
    * パケット構造
        * Helloパケット
            * ネイバー（neighbor）を確立し、DR／BDRの選定を行い、さらにそれを維持する
                * マルチキャスト（224.0.0.5）、全てのOSPFルータ宛
        * DBD：Database Descripitionパケット
            * LSAヘッダのリストを提示する（相手はその中から必要なLSAをlSRで要求する）
        * LSR：Link State Requestパケット
            * 必要なLSAを要求する
        * LSU：Link State Updateパケット
            * 相手が必要だと言っているLSAを送信する
        * LSAck：Link State Ackパケット
            * 要求したLSAを受け取ったことを相手に通知する（Explicit  Ack）
        * マルチキャスト：DR／BDR→224.0.0.5（全てのOSPFルータ宛）、DR Other→224.0.0.6（DR／BDR宛）
        * ユニキャスト
    * パケットフォーマット
        * OSPFv2はIPv4のプロトコル番号89
            * version：4ビット
            * IHLヘッダ長：4ビット
            * TypeOfService：8ビット
            * TotalLength：パケット長：16ビット
            * Identification：16ビット
            * gsフラグ：2ビット
            * Fragment Offset：14ビット
            * TTL：4ビット
            * プロトコルID：4ビット
                * OSPFv2は89
            * Header Checksum：16ビット
            * Source IP Address：32ビット
            * Destination IP Address：32ビット
            * OSPFパケットヘッダ
                * version：8ビット
                    * OSPFのバージョン情報、IPv4の場合はバージョン2、IPv6の場合はバージョン3
                * Type：8ビット
                    * Hello：1、DBD：2、LSR：3、LSU：4、LSAck：5
                * Packet Length：16ビット
                * Source Router ID：32ビット
                    * 送信元のルータを一意に識別するID、手動や自動ともできるルータがある
                * Area ID：32ビット
                * Checksum：16ビット
                * Au Type：16ビット
                    * 0：認証なし
                    * 1：クリアテキストによる認証（パケットキャプチャをされたらあっさりと認証を破られる）
                    * 2：MD5ハッシュによる認証
                * Authentication：64ビット
                    * Au Type0の場合は無視
                    * Au Type1の場合はクリアテキスト形式のパスワード
                    * Au Type2の場合
                        * 先頭0x0000
                        * Key ID：8ビット
                            * 認証アルゴリズムとハッシュを生成するための秘密鍵を決定する
                        * Auth Length：8ビット
                            * パケットの最後に付けられるハッシュ認証情報の長さ（単位はバイト）
                        * Cryptographic Sequence Number
                            * リプレイ攻撃対策で利用されるシーケンス番号
                * パケットType毎に決められたField
            * OSPFパケットデータ
    * LSA：Link State Advertisement
        * OSPFルータ関係で交換されるリンク状態情報です
            * 代表的なタイプ
                * Router-LSA
                    * 全OSPFルータが作成され、エリア内部に、自ルータのリンク情報を通知する
                * Network-LSA
                    * 指名ルータが作成され、エリア内部に、自エリアのネットワーク情報を通知する
                * Network-Summary-LSA
                    * 指名ルータが作成され、エリア内部に、他エリアのネットワーク情報を通知する
                * ASBR-Summary-LSA
                    * エリア境界ルータが作成され、エリア内部に、AS境界ルータの情報を通知する
                * AS-External-LSA
                    * AS境界ルータが作成され、全体に、非OSPFネットワークの経路情報を通知sうる
    * アルゴリズム
        * SPF（ダイクストラ法）
    * その他
        * TCP、UDPを利用ではなく、直接IPデータグラムにカプセル化する
        * 処点のネットワークを相互接続ため、OSPFパケットをトンネリングプロトコルでカプセル化することが必要
            * ネットワーク層のプロトコル（IP、IPsecなど）をトンネリングするプロトコルには、GRE（Generic  Routing Encapsulation）があり、データリング層のプロトコル（PPPなど）をトンネリングするプロトコルには、L2TPがある
                * GREやL2TPは暗号化機能がないため、IPsecなどのセキュリティプロトコルと合わせて使用され→GRE over IPsec、L2TP over IPsec
###### BGP：Border Gateway Protocol
* AS間を接続する時に利用されるプロトコルで、EGPの分類に所属
    * インターネット全体をカバーするように経路制御を行い、基準は通過するASの数となる（重み未対応？）
        * BGPスピーカ
            * BGPの経路情報を発信するルータです、BGPのコネクションを確立し、お互いにBGPの情報を交換する
        * EBGP：External BGP
            * AS間でBGP情報やりとりする
                * AS間で対抗して設置されているピアまたはネイバーと呼ばれるルータ間で経路情報をやりとり
                    * ピア間で交換されるのは、インターネット全体の経路を表すフルルートと呼ばれる情報、最初はすべてのルーティングテーブルを交換し、その後差分情報のみを相手ルータにアップデート
        * IBGP：Internal BGP
            * AS内でBGP情報をやり取りする
                * AS内の全てのBGPルータとの間でIBGPセッション（IBGPピア）を確立　→フルメッシュ状態
                    * しかし、ルータの数を増えるにつけセッションの数が膨大になりがちです
                        * 対策例
                            * ルータをクラスタリングし、ルートリフレクタとなるルータと、そのクライアントとなるルートリフレクタクライアントに分け、ルートを中心にクライアントが発行した全てのアップデート情報を受信し、それを他のクライアントに配布する．
                                * フルメッシュを中心型に変えて、IBGPセッションの数を減らせる
        * コンフェデレーション
            * 複数のASを一つのASに包含すること
        * パス属性
            * ORIGIN、AS_PATH、NEXT_HOP、MULTI_EXIT_DISC（MED）、LOCAL_PREFなどの属性がある
                * AS_PATH属性は、経由するAS番号の列を示す
                    * AS番号を複数設定して、ASパスプリペントと呼ばれる手法で優先制御をする
#### レイヤ3スイッチ
##### ネットワーク層までのデータを転送するスイッチ
###### ルータとの区別
* 多くのプロトコルに対応し、主にソフトウェアで処理を行うものがルータ．イーサネットを中心に対応し、主にハードウェア処理を行うものがレイヤ3スイッチ
## プロトコル
### ICMP：Internet Control Message  Procotol
#### パケットフォーマット
##### ICMPヘッダ
###### タイプ：8ビット
* 代表値
    * 0：コード応答：Echo Reply
    * 3：到達不能：Destination Unreachable
        * 主な理由コード
            * 0：ネットワーク到達不能：Network Unreachable
            * 1：ホスト到達不能：Host Unreachable
            * 3：ポート到達不能：Port Unreachable
            * 4：フラグメンテーションが必要：Fragmentation Needed and Don’t Fragment was Set
            * 5：ソースルーティングが失敗：Source Route Failed
            * 9：送信先ネットワーク拒否：Communication with Destination Network is Administratively Prohibited
    * 4：始点抑制：Source Quench
        * フロー制御を行うためメッセージ、例：ルータがパケットを処理できる限界まで受け取ってしまった時に、送信もとに対して、もう少しゆっくり送ってほしいという要求を出すときに使う
    * 5：リダイレク：Redirect
        * ルータが受け取ったIPパケットの送信先がそのルータで処理するのに適切でない場合、より適切なルータに送信するように通知する（一般的には手動でルータに設定必要）
    * 8：エコー要求：Echo Request
    * 9：ルータ広告：Router Advertisement
    * 10：ルータ請願：Router Solicitation
    * 11：時間超過：Time Exceeded
        * TTLが0になった時に通知する
    * 併せって利用、自身が接続しているネットワークのルータを見つける
###### コード：8ビット
* タイプメッセージごとの詳細内容を示す、上の3：到達不能の詳細理由にもここに該当する
###### チェックサム：16ビット
* ICMPヘッダを含む ICMPメッセージ全体に対してのチェックサム
##### ICMPデータ
###### ICMPタイプごとのデータ
#### 種類
##### 障害対策などで診断を行うために情報のお問い合わせを行う情報メッセージ
###### 一般は要求と応答がペアしている
##### エラーが起きた時にエラー通知を行うエラーメッセージ
###### エラーが発生する場合通知され
#### コマンド
##### ping：Packet INternet Groper
###### ICMPエコー要求を送信し、ICMPエコー応答またはエラー応答が返ってくれて完成
##### traceroute
###### ICMP時間超過メッセージを利用したソフトウェア、TTLを1から順次に増やしながらUDPパケットを送信し、途中でパケットを破棄したルータにICMP時間調査メッセージを無理やり返させ、それより、通過するルータのIPアドレスを一つずつ知らせることができる
#### ICMPv6
##### IPv6版、IPv4に比べ、ICMPの役割が非常に大きくなっていた
###### 例：IPv6では、IPアドレスからMACアドレスを調べる仕組みのARPをICMP近隣探索メッセージ変更されていた
##### タイプでエラーメッセージ（0〜127）と情報メッセージ（128〜255）を明確に分けている
### ARP：Address Resolution Protocol
#### IPアドレスからMACアドレスを求めるためのプロトコル
##### 送信元IPアドレスと送信先IPアドレスを比較して、あて先IPアドレスが同一ネットワークにある時には、その宛先IPアドレスのMACアドレスを調べ．
宛先IPアドレスが違うネットワーク上にある時には、次に送るルータのIPアドレスからMACアドレスを調べ
###### ルータテーブルに決めない時、デフォルトゲートウィを調べ
#### パケットフォーマット
##### ハードウェアタイプ：Hardware Type
###### 16ビット：どのようなデータリンクを使用しているかを示す．イーサネットの場合は1
##### プロトコルタイプ：Procotol Type
###### 16ビット：ネットワーク層のプロトコルを示す、Ethernetフレームのタイプフィルードと同じ値で、IPの場合は0800
##### HLEN：Hardware Length
###### 8ビットで、ハードウェアアドレスの長さ（バイト）を示す、MACアドレスの場合は6バイト
##### PLEN：Procotol Length
###### 8ビットで、プロトコルアドレスの長さを示す、IPアドレスの場合は4バイト
##### オペレーション：Operation
###### 16ビットで、ARP要求パケットかARP応答パケットかを示す、ARP要求パケットの場合は1、ARP応答パケットの場合は2
##### 送信元MACアドレス
###### 48ビット：ARP応答パケットでは、ここにARP要求パケットで求めていた MACアドレスが設定され返され
##### 送信元IPアドレス
###### 32ビット
##### 探索するMACアドレス
###### 48ビット：ARP要求パケットではここがわからないので、通常は0が設定され、ARP応答パケットでは、ここに宛先のMACアドレスが設定され
##### 探索するIPアドレス
###### 32ビット：ARP要求パケットでは探索するIPアドレスを設定、ARP応答パケットでは、宛先（要求パケットの送信元）のIPアドレスが設定される
#### 仕組み
##### 端末のARPテーブルにキャッシュがない　→ ARP要求パケットをネットワーク上ブロードキャスト　→ 当てはまる端末はARP応答パケットを返信
#### 本役以外の利用場面
##### GARP：Gratuitous ARP
###### 自分自身のIPアドレスや使用予定のIPアドレスを設定して送信する ARPパケットのこと
* IPアドレスの重複確認
    * DHCPなどでIPアドレスの割り当てるときに、そのIPアドレスが既に使用されていないかを確認する
        * 割り当てようとするIPアドレスに向けて ARP要求パケットを送ることで確認できる
* 同一セグメントのネットワーク機器上のARPキャッシュを更新させ
    * VRRPでは、ルータが切り替わった時にスイッチ更新のために使用され
##### ネットワーク監視
###### 同一ネットワーク内でいるがあるかどうかを確認したい場合で利用
* IPアドレスを基にネットワークの生存確認を行う場合には、通常はpingを用いる
### RARP：Reverse Address Resolution  Procotol
#### ARPの逆で、MACアドレスからIPアドレスを取得するためのプロトコル
##### 組込み機器などで、IPアドレスを保持して億ハードディスクがない場合などに用いられる
##### RARPサーバが必要です、そのサーバ上にMACアドレスとIPアドレスの組を登録している
### プロキシARP
#### VLSMやCIDRに対応していない機器は、クラスしかネットワークアドレスを判断できない、そのような旧型の機器の場合、別のネットワークを同じネットワークと勘違いして、宛先ホストに向けて直接、ARP要求パケットを出すことがある
##### これに対して、ルータが代理でARP応答パケットの返信を行い、ルータが一旦、その機器からのパケットを受け取って別のネットワークに中継することができる、この仕組みをプロキシARP、または代理ARPと呼ばれる
### NAT：Network Address Translation
#### IPヘッダに含まれる IPアドレスを別のIPアドレスと変換して、ローカルなネットワークではプライベートIPアドレスを使用し、インターネットに接続するときにグローバルIPアドレスに変換するための技術
##### NAT対応のルータの内部には、アドレス変換のためのNAT対応テーブルが作られている、ホストAから最初にインターネットに向けてパケットが送られた時に NAT対応テーブルを作成する
###### グローバルIPの制限のため、IPアドレスだけを行うNATでは、一度に一つのIPアドレスで通信を行うことができるホストは一台のみです
### NAPT：Network Address Port Translation／IPマスカレード
#### 一つのIPアドレスでポート番号を変えることで、複数のホストの同時接続が可能にしたのがNAPT
##### 変換テーブルにはIPアドレス以外ポート情報にも同的に保持する、IPアドレス＋ポートすべて一致での変換を行う
### VRRP：Virtual Router Redundancy  Protocol：仮想ルータ冗長プロトコル
#### ルータの冗長化を行うためのプロトコルで、VRRPでは仮想ルータと言う考え方を利用して、複数台のルータを一台のルータとして扱える
##### LAN内の二重化対策として利用されている
##### 仕組み
###### 仮想ルータには、仮想のIPとMACアドレスが持っている、マスタとバックアップの間VRRP広告（VRRPアドバタイズメント）を交換してプライオリティ値が大きなルータが優先ルータつまりマスタとなり．

VRRPでの死活監視でマスタが故障したと判断すると、バックアップは自動的にGARPを利用して仮想MACアドレスとIPアドレスを引きつき

相応的に、スイッチングハブなどはポート紐作りも学習し直し新ルートになり
* VRRP広告：ローカルマルチキャストアドレス224.0.0.18で送信されている
###### VRRPグループ ID（VRID）を複数設定し使い分け、複数の仮想ルータを設定するも可能
* 負荷分散も実現できる
    * 例：二つゲートウェイお互いバックアップになり、接続端末ではそれぞれこの二つをGWに設定する利用で、バックアップと負荷分散両方とも実現できる．ただ、接続端末ごとのGW設定が必要です
###### 複数のインタフェースでVRRPを構成する際に、一方のインタフェースが故障したら、もう一方のインタフェースも切り替えるが必要、この時、VRRPトリガ（またはVRRPトラッキング）を利用して、マスタルータを連動して切り替える
* 例、ネットワーク1とネットワーク2はVRRPを利用してバックアップ＆負荷分散の二つルータで接続している
    * この場合、ルータがネットワーク1向けのインタフェースが故障される場合、このルータのネットワーク2向けのインタフェースも切り替えが必要となる、このルータはもうネットワーク1と2の連結はできなくなるためです
        * VRRPトリガ：予め監視対象インターフェースと障害検出時のプライオリティ値を設定し、一方の障害を検出したらもう一方のインタフェースのプライオリティ値を下げ、これにより、もう一方のインタフェースでもマスタルータとバックアップルータが切り替え、ネットワーク間の通信が継続可能になる
### NATの問題点
#### NATの裏側のサーバは外側から接続できない
##### 家庭内サーバやP2P通信などで問題が起こってきる→NATトラバーサル
#### NAPTは、ポート番号のないアプリケーションやポート番号が変化するアプリケーションで利用できない
##### 例：VPNで使用するIPsecなど、ポート番号が暗号化されて見えないプロトコル　や　FTPなど、通信の途中でポート番号を複数使い変化させるプロトコル
#### 変換処理のオーバヘッドでルータに負荷がかかる
##### 遅延問題や負荷より障害発生など
#### 対策
##### NATトラバーサル（NAT越え）
###### 基本的には、NAT（NAPT）を前提にアプリケーションなどで対応することで、NATトラバーサルを実現
###### IPsecで必要なパケット（IKE：鍵交換、ESP：暗号化パケットなど）をすべて通過させるために、ルータにIPsecパススルー機能を搭載する
###### P2Pの機器などが外部と接続するため、NATルータにつけられているグローバル IPアドレスを機器に伝える動きをする（UPnP：Universal Plug and Play）という仕組みが利用されることもある
