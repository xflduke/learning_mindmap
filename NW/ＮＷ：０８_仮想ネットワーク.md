# ＮＷ：０８_仮想ネットワーク
## 仮想化
### とは
#### 仮想OSを用いて一台の物理サーバで複数の仮想マシンを仮想させ、複数台の物理リソースを一つのサーバに仮想させ
### 仮想化機構
#### メリット
##### 経済性
###### ハードウェアを集約して台数を削減できる
###### ハードウェアの資源を効率よく活用できる
###### 物理的なサーバの運用管理業務を減らすことができる
##### 拡張性
###### ハードウェアを柔軟に拡張できる
##### 独立性
###### ハードウェアとOSやアプリケーションを切り離すことで、ハードウェアに依存せずOSなどを選べる（逆に仮想かソフトウェアに依存され）
#### デメリット
##### 仮想化によるオーバヘッド
###### 仮想化ソフトウェア自体がCPUやメモリなどのリソースを消費している
###### ネットワークやVLANが複雑になり、仮想化ネットワークによる独自の制御が必要
##### 設計や管理が複雑になる
###### 物理サーバと仮想サーバの両方の設計や管理を行う必要があるので、それらの作業が複雑になり
###### 物理サーバと仮想サーバだけでなく仮想スイッチなども管理する、ネットワークの運用も煩雑になる
### 仮想化方式
#### 仮想化技術
##### ホストOS型
###### ホストOSのミドルウェアとして仮想化ソフトウェアをインストール方式
##### ハイパーバイザ型
###### 仮想化機構を動作させるためのOSを必要としない方式、ハードウェア上で直接稼働するハイパーバイザ型のソフトウェアによって仮想化を実現している
#### クライアント仮想化
##### クライアントに関する情報をサーバに保持しておき、ネットワーク経由でそれをクライアントに転送する
###### この場合の端末は一般的にシンクライアント（TC）を使う
* TC
    * ネットワークブート型
        * PCのネットワークブートの仕組みを利用した方式、サーバに保存したクライアントイメージファイルをTCがネットワーク経由でダウンロードし、OSやアプリケーションを実行する
            * この場合、CPUやメモリはシンクライアントのものを使う通常のPCと同様に使用できるが、起動やシャットダウンするたびに大量のネットワークトラフィックが発生、利用場面が限定されている
    * 画面転送型
        * OSやアプリをサーバ側で実行し、画面出力のみをシンクライアントに転送する方式、画面情報と操作情報だけをやり取りするため、ネットワークトラフィックが少なくなり
            * 1．ダーミナルサービス方式：SBC：Server Base Computer
                * サーバにOSやアプリを構築、ユーザがそれぞれRDP方式で利用する、一サーバで複数ユーザセッション切り離して運用．単一のクライアントPC環境を共有するので、アクセスが集中するとパフォーマンスが低下する、アプリによってSBC方式に対応しない可能性もある
            * 2．ブレードサーバ方式：Blade Server
                * ブレードサーバを利用する方式、一クライアントごとに一ブレードを割り当てることでマルチユーザに対応する
                    * ユーザごとにラックにブレードが必要ので、初期導入コストや工期がかかり、拡張性もやや弱い
                    * ブレードサーバ：HDDをはじめメインメモリやストレージなどnおサーバーリソースを、一つの小さな筐体に搭載したサーバ
            * 3．デスクトップ仮想化方式
                * 仮想デスクトップ基盤（VDI：Virtual Desktop Infrastructure）を整備し、仮想デスクトップを稼働させる
### 仮想ネットワーク
#### 構造イメージ
##### 物理NICの役目
###### 1．各仮想サーバのデータを、仮想スイッチなどを経由して転送する
###### 2．仮想かソフトウェア、ハイパーバイザなど、仮想化に関連する管理情報を転送する
###### 3．ストレージ装置とのやり取りを行う
###### 4．障害発生時や負荷を調整する時などに、仮想サーバを他の物理サーバに移動する
### 関連技術
#### チーミング
##### 複数の機器をまとめて、帯域増大や負荷分散、冗長化を行う仕組み
###### 例
* NICを論理的に束ねて一つにみせる
    * 負荷分散には、MACアドレスやIPアドレスで分散したり、明示的に選択したりするなどの方法がある
* スイッチとサーバ間の接続はリンクアグリゲーション、NICはチーミング
#### ライブマイグレーション
##### 仮想マシンを仮想させたままの状態で他の物理サーバに移行させる機能
#### EVB：Edge Virtual Bridging
##### サーバを仮想化した際のネットワーク規格、IEEE802．1Qbgで策定されていたが、現在はIEEE802．1Q（VLANの規格）に組み込まれている
###### 仮想化によりの性能落ちに対して、仮想スイッチが担っていた処理を物理NICや物理スイッチにオフロードさせ、具体的には、物理NICでオフロードするVEB（Virtual Ethernet Bridge）や物理スイッチでオフロードするVEPA（Virtual  Ethernet Port Aggregator）などの仕組みがある
## ストレージ
### SAN：Storage Area Network
#### ストレージを扱うための専用のネットワーク、通常のLANよりも高速で効率的にデータ転送を行うことができる
##### SANでは、ファイルごとではなくディスクのブロックごとにデータにアクセスしている、アプリケーション層のプロトコルとして、SCSIプロトコル（Small  Computer System Interface）
###### SCSIデータ転送するために、ファイバチャネルでは物理層から順にFC−0、FC−1、FC−2、FC−3、FC−4の五つ階層モデルで定義している
* FCP：Fibre Channel Protocol（FC−4）
    * トランスポート層相当
        * SCSI→FCP→FC−x
* FCIP：Fibre Channel over IP
    * SANにはファイバチャネルを使ったFC−SAN以外、通常の IPネットワークを使ったIP−SANもある
        * FCプロトコルをIPでカプセル化するのはFCIP
            * SCSI→FCP→FCIP→TCP→IP→Ethernet
* iSCSI：Internet SCSI
    * FCを使わずにSCSIプロトコルを直接利用する
        * SCSI→iSCSI→TCP→IP→Ethernet
* FCoE：Fibre Channel over Ethernet
    * データリンク層のレベルで拡張イーサネットを使用してFCフレームを転送する技術
        * SCSI→FC→FCoE（ネットワークインタフェース層）
        * TCP／IP通信でのカプセル化を行わないので、通信は同じデータリンク層の範囲に限られるが、より効率的にパケットを転送することができる
    * FEoEフレーム
        * 宛先MACアドレス
        * 送信元MACアドレス
        * VLANタグ
        * タイプ（FCoE）
        * バージョン
        * リザーブ
        * データ（平均2112バイト）
            * 一般なイーサネットMTU（Maximum Transmission Unit：1500バイト）よりも大きくなっているので、FCoEを利用するにはイーサネットのMTUを大きくするジャンボフレームを活用する必要がある
        * FCS
        * VLANタグを利用し、FCoEフレームであることを示す
    * イーサネットはフレームが確実に届くことを保証していないに対して、FCではデータが途中で失われることがなく、確実に届くことを保証している
        * FCoEを用いることで、パケットログのない通信（ロスレスイーサネット）を実現できる
### NAS：Network Attached Storage
#### ネットワークに直接接続するファイルサービス専用のサーバ
##### ファイル共有のためのプロトコルには、Windows上はSMB（Server Message Block）や、UNIX系 OSの多くでサポートするNFS（Network File System）、CIFS（Common Internet File System）などが利用される
#### 関連技術
##### RAID：Redundant Arrays of Inexpensive  DIsks
##### NASゲートウェイ
###### NASからストレージ本体を取り除いたも、ストレージは別の場所のものを利用する．SMBなどのファイル共有プロコとコルをSCSIなどの入出力プロトコルに変換する
* NASゲートウェイを用いるとストレージにSANを利用することができ、柔軟にストレージを増加させることができる
* 利用上はNASですが、ゲートウェイの裏ではSANを利用した環境です．
##### シン・プロビジョニング
###### 物理的なストレージ容量を仮想化して、必要に応じて自由に変化させることができる技術
* 仮想化された論理的なストレージをボリュームと言い、このボリュームは実際の物理的な容量と無関係に設定することができる
    * 物理的な容量が増えた時に新たにサーバを設定し直す必要がないため、事前のキャパシティプランニングが不要となっている
## 仮想ネットワーク
### クラウド
#### 公開
##### パブリッククラウド
##### プライベートクラウド
#### サービス形態
##### SaaS：Software as a Service
###### ソフトウェア（アプリケーション）をサービスとして提供する
##### Paas：Platform as a Service
###### OSやミドルウェアなどの基盤（プラットフォーム）を提供する
##### IaaS：Infrastructure as a Service
###### ハードウェアやネットワークなどのインフラを提供する
### 関連技術
#### CDN：Content Delivery Network：コンテンツ配信網
##### Webの動画などのコンテンツをインターネット経由で配信するために最適化されたネットワーク
##### 例：AWS CloudFront
### 仮想化方式
#### ホップバイホップ方式：hop by hop
##### OpenFlowを前提に作られている、カプセル化を行わず、仮想化に対応したスイッチのみを物理的に直接繋ぐことによって仮想化ネットワークを構築する
#### オーバレイ方式：Overlay
##### 仮想化に対応したスイッチに直接繋ぐことが難しい環境で、既存のネットワーク環境上、IPトンネルなどの技術を利用してカプセル化を行い、フレームを転送する方式
####  ハイブリッド方式
##### 併用
### 仮想化技術
#### SDN：Software-Defined Network
##### ソフトウェアの設定のみで、ネットワークの構成や機能、性能などを動的に設定する技術
##### アーキテクチャ
###### アプリケーション層
* APIを通じて、ネットワークのさまざまな処理をプログラムすることができる
###### コントロール層
* SDN制御ソフトウェアなど
    * ネットワークサービス
* 機器を制御する中心部となるレイヤ、インフラストラクチャ層のネットワーク機器のそれぞれの違いを吸収して抽象化した機能として、アプリ層へ提供する．この部分のAPIをNorthbound APIと呼ぶ
###### インフラストラクチャ層
* ネットワーク機器など
* OpenFlowなどの標準プロトコルや、機器ごとに定義されたAPI（Application  Programming Interface）を利用する、この部分のAPIをSouthbound API と呼ぶ
##### 代表例
###### OpenFlow
* 各フレームが持つMACアドレスやVLANタグ、IPアドレス、ポート番号などのような特徴をフローとして扱い、そのフローをベースにスイッチイングを行い、経路を柔軟に制御できるようにするための標準化規格
    * 信頼性の高い通信を提供するため、通信にはTCPに加えてTLSを用い、セキュアチャネルと呼ばれる通信路を確立する
    * レイヤ2ネットワークである
* 代表的な特徴は、制御用ネットワークとパケット処理用ネットワークが分離されている点です
    * コントロールプレーン
        * OpenFlowコントローラと呼ばれる機器を用意し、経路制御などの管理機能を実現する
    * データプレーン
        * OpenFlowスイッチと呼ばれる機器がパケットのデータ転送を行い
    * 両方は分離させて別々用意必要ですが、必ず物理的に分離させるではなく、仮想ネットワークを構築することも可能です
* フローテーブル
    * フローエントリと呼ばれる処理ルールと、そのルールに当てはまった時のアクションの組み合わせを登録する
        * ルールには、送信元や宛先のMACアドレス、IPアドレス、ポート番号、VLAN IDなど様々ある
    * 設定方式には複数あり
        * プロアクティブ型：Proactive型
            * OpenFlowコントローラでは、予め設定されているフローエントリの情報をOpenFlowスイッチに送信する
        * リアクティブ型：Reactive型
            * OpenFlowスイッチが未知のパケットを受け取った時にOpenFlowコントローラ指示を判別し処理する
##### 関連技術
###### sFlow
* ネットワークのトラフィックを分析するためのプロトコル．フローごとの統計情報を、ネットワーク機器にあるエージェントがコレクタと呼ばれるサーバに送信する時に使用される
    * 同様のプロトコルに、Ciscoが提供するNetFlowがある
###### VXLAN：Virtual eXtensible Local Area Network
* イーサネットフレームをカプセルかすることで、レイヤ3のネットワーク上に論理的なレイヤ2ネットワークを構築するためのトンネリングプロトコルです
    * レイヤ2ネットワークであるOpenFlowのネットワークを、オーバレイ方式を用いてIPネットワークで透過させる場合などに使用される
###### イーサネットファブリック：Ethernet Fabric
* 一つまたは複数のスイッチによって構成されるネットワーク全体のトポロジー（Topology：構成の形態）のことです
    * 主に従来のイーサネットの「ループするトポロジーが形成できない」で、STPなどで、ループを回避する設定を行うとブロッキングポートの部分のネットワークが活用されず、無駄の多いネットワークになる．その対策としての新しい技術です
###### TRILL：Transparent Interconnection of Lots of Links
* IETFで標準化が勧めている規格、イーサネットで経路を冗長化する技術．ECoEやサーバの仮想化と相性がよく、組み合わせ利用することが多い．RFC6325で“Routing Bridge”として定義されている
    * STPと違いところは、経路の長さが同じ場合に、一定のアルゴリズムで経路を選択し、転送効率と負荷分散を図る
    * OpenFlowと同様に、データプレーンとコントロールプレーンを分けて実装され、LANとSANのネットワークを統合するときに管理しやすい利点がある
###### NFV：Network Functions Virtualization
* ネットワーク機器の機能を仮想マシンとして実現する方式、SDNとは異なり、サーバではなくネットワーク機器を仮想化する．ルータ、スイッチ、ファイアウォールなどの専用機器を仮想化機構の仮想マシンとして動作させ、設備投資や運用コストを低減できる
