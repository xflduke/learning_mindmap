# ＮＷ：０３_トランスポート層
## TCP
### 転送を制御するプロトコル、コネクションを確立して仮想的な通信路を確保することで、相互に通信を行い．仮想回線方式です．
#### 構成
##### TCPヘッダ
###### 送信元ポート番号：16ビット
###### 宛先ポート番号：16ビット
###### シーケンス番号：32ビット
* 順位番号を示す、コネクション確立時に初期値がランダムに決められ、SYNパケットで受信ポストに伝え．転送したバイト数を初期値に加算していく
    * SYNパケットやFINパケットは、データを含んでいなくても1バイト分と数えられる
###### 確認応答番号：32ビット
* 次に受信すべきデータのシーケンス番号、＝シーケンス番号＋1
###### データオフセット：4ビット
* TCPのデータがTCPパケットのどの部分から始まるのかを示す、単位は4バイト
    * 例：オプションを含まないTCPヘッダの場合はTCPヘッダ長は20バイト、個の場合のデータオフセットは5となり
###### 予約：4ビット
* 保留、通常は0にしておく必要
###### コントロールフラグ：8ビット
* 1ビットずつ別の意味を持つフラグ
    * ビット０位
        * CWR：Congestion Window Reduced
            * IPヘッダのECNフィールドとともに使用されるフラグ．輻輳ウィンドウを小さくしたことを通信相手に伝える
    * ビット１位
        * ECE（ECN−ECHO）
            * IPヘッダのECNフィールドとともに使用されるフラグ．相手からこちら側に向かうネットワークが輻輳していることを通信相手に伝える
    * ビット 2位
        * URG：Urgent Flag
            * このビットが1の場合、緊急に処理すべきデータが含まれていることを示す、緊急を要するデータの格納場所は、緊急ポインタを使用して示す
    * ビット３位
        * ACK：Acknowledgement Flag
            * このビットが1の場合、確認応答番号のフィールドが有効であることを示す、コネクション確立時の最初のSYNパケット以外は、必ず1でなければならない
    * ビット４位
        * PSH：Push Flag
            * このビットが1の場合、受診したデータをすべてに上位のアプリケーションに渡すが必要がある．0の場合には、すぐに渡さずバッファリングすることが許される
    * ビット５位
        * RST：Rest Flag
            * このビットが1の場合、コネクションが強制的に切断される．何らかの異常が検出された場合に使用するフラグ
    * ビット６位
        * SYN：Synchronize Flag
            * コネクションの確立に使われ、このビットが1の場合、コネクションの確立を要求するとともに、シーケンス番号に格納されている数字でシーケンス番号を初期化する
    * ビット７位
        * FIN：Fin Flag
            * このビットが1の場合、以後送信するデータがないことを示す．通信が終了し、コネクションを切断したい場合に使用する
###### ウィンドウサイズ：16ビット
* 一たびに受信できるデータ量です、確認応答番号で示した位置から、受信可能なバイト数を示す．TCPでは、ここに示されているデータ量を越えて送ることは許されません
###### チェックサム：16ビット
* TCPヘッダとTCPデータ全体のチェックサム、省略できません
    * 注意：TCP／UDPと違って、IPヘッダのチェックサムはIPヘッダだけが対象
###### 緊急ポインタ：16ビット
* URGの場合利用、緊急を用するデータの格納場所を示すポインタです．データ領域の先頭から、この緊急ポインタで示されている数値分のオクテット数のデータが緊急を用するデータになる
###### オプション：24ビット
* 性能向上させるためのもの、最大セグメント長（MSS：Maximum Segment Size）を決定することや、セグメントが「歯抜け状態」で届いた時に複数の確認応答を返すことができる選択確認応答（SACK：Selective ACKnowledgement）を利用することなどが可能
    * 代表オプション
        * タイプ0
            * End Of Option List
        * タイプ1
            * No−OP
        * タイプ2
            * ４バイト、MSS
        * タイプ4
            * 2バイト、SACK  Permitted
        * タイプ5
            * Nバイト、SACK
    * 歯抜け状態
        * 途中のセグメントが所々消失して、全体的に繋がっていない状態のこと
###### パディング：8ビット
##### TCPデータ（TCPペイロード：TCP Payload）
###### 上位プロトコルのヘッダとデータ
#### 流れ
##### １．コネクション確立
###### SYN→ SYN／ACK←ACK→
* ３ウェイハンドシェイクと呼ばれる
##### ２．データ転送
##### ３．コネクション解放
###### FIN→ACK←FIN←ACK→
* 確立より一回多く、４回が必要
#### 信頼性
##### シーケンス番号
###### 最初にSYNパケットを送るときに、ランダムに決めた初期値を設定下シーケンス番号を、通信相手に送る
* 注意：コネクション確立のSYN／ACKも送信機器としての最初のSYNので、このパケットにも予めランダムのシーケンス番号をとる
##### 確認応答番号
###### 通信相手は、パケットを受け取ったら確認応答を返し、次に受け取るべきデータのシーケンス番号を確認応答番号として返す
* 確認番号＝受取ったシーケンス番号＋データバイト数
    * 実際のデータがなくても、SYNパケットとFINパケットは１バイトのデータとして取り扱われる
##### TCPの再送機能
###### シーケンス番号に対応する確認応答番号が受け取れない場合、ホストはもう一度、同じシーケンス番号のパケットを送る
#### ウィンドウ制御
##### 信頼性の一発送一応答（パケットの往復時間：ラウンドトリップ時間）の性能問題に対して、ウィンドウという概念を使って、一度に複数のパケットを送れるようになる
###### ウィンドウサイズ：確認応答を待たずに送信できるデータの大きさ
* 例：ウィンドウサイズが4000で、１パケット1000ずつデータが送られる場合、4パケットを同時に送ることができる
###### 確認応答パケットが一つ返ってくると、ウィンドウサイズをずらし、次のパケットを送る．ウィンドウをずらすこの仕組みを、スライディングウィンドウと言い
* 注意：ウィンドウ中のシーケンス番号は連続に限らないです
#### フロー制御
##### ネットワーク混雑や受信ホストが受信しきれないの対処、ウィンドウサイズを利用して、送信するデータ量を調節する
###### 受信ホストが、TCPヘッダのウィンドウズサイズフィールドを使って、送信側へ１度に送って処理仕切れるサイズを通知できる
* 基本的に、通信に余裕がある時には、ウィンドウサイズを大きくして、高いスループットでの通信を実現．受信バッファが溢れそうな時には、ウィンドウサイズを小さくしてデータの送信量を抑制する
#### 輻輳制御
##### 通信回線の混雑を解消するため、ウィンドウサイズを使って通信量を調節する
###### アルゴリズム
* Tahoe（1988年に発表）
    * スロースタート
        * 通信の最初はウィンドウサイズを1セグメント（１MSS）に設定してデータパケットを送信、上々に2、4に大きくする
            * 途中でタイムアウトなどのエラーが起こったら、再度ウィンドウサイズを１セグにしとにして再送
    * 高速リカバリ
        * 転送効率を上げるため、輻輳検出による再送後のcwndを小さくしすぎないようにする方法
            * 輻輳の程度が小さい場合に有効、タイムアウトによる再送は、輻輳の程度が大きいと考えられ、スロースタートからの再開が適している
                * 例：輻輳を検知すると、cwndを半分に減少させ、同時にこの値をssthreshとして保存する．そして、cwndにさらに再送セグメント加えた大きさに一時的に設定して高速再転送する、再送ご、輻輳回避のssthreshへ戻る
                * スロースタートでは指数的にcwndが拡大するため、時間の経過とともにデータ転送量が大幅に増えている、輻輳を検知してcwndを低下させた後にも続ければ、またすぐに輻輳を起こしてしまう可能性が高いです
    * 輻輳回避
        * 輻輳を検知した時点でのcwndの半分の値をスロースタート閾値（slow start threshold、ssthresh）として設定する、そして、cwndがssthreshに達した後は、ACKを受け取るたびに増やす輻輳ウィンドウの増加分を緩やかにすることで、輻輳を発生させにくくする
            * cwnd = cwnd + mss / cwnd
* ほかCUBIC、BBRなどもある
#### TCPコネクションの範囲
##### 基本的に通信を行う相手との間で確立する、最終的な目的の相手とは限らず、通信データをやりとりし、データの転送を行う相手となる
###### 例：プロキシサーバ、中継サーバなど、アプリケーション層レベルでの中継を行う場合にも、TCPコネクションはクライアントと中継するサーバ、中継するサーバとサーバとの間でそれぞれ確立する
## UDP
### IPと類似で、コネクションレス型で一つ一つのパケットを独立して送る、アプリケーションから要求があったデータを特に制御せず、そのまま通信回線に流すのデータグラム方式です
#### 特徴
##### TCPで行っているフロー制御や順番制御などの制御は一切行われない、そのため、ネットワークが混雑していても要求があればそのまま送り、データの再送も行わない、信頼性が必要な場合、アプリやユーザ側が考慮が必要
##### その反面、低リレー、高速通信ができ
##### 上位層の例
###### TFTP（Trivial FTP：簡易なFTP）
* アプリケーション層で信頼性を確保するもの
###### DNS、SNMP、NTP
* 通信パケットが小さいもの
###### RTPなどの動画や音声のストリーム配信
* 信頼性よりリアルタイム性が重視されるもの
###### DHCP、RIP
* マルチキャスト、ブロードキャストの配信が必要なもの
#### パケット
##### 送信元ポート番号：16ビット
##### 宛先ポート番号：16ビット
##### パケット長：16ビット
###### UDPヘッダとUDPデータの長さの合計、単位はオクテット
###### このフィールドは、TCPヘッダにはなく、UDPヘッダのみに設定されている
##### チェックサム：16ビット
###### 計算時には、IPアドレスも含んだUDP擬似ヘッダを使用する
###### UDPのチェックサムは省略可能、この場合は全0設に定
##### UDPデータ（UDPペイロード：UDP Payload）
###### 上位プロトコルのヘッダとデータ
##### UDPヘッダ
## 役割
### 通信するアプリケーションに適切にパケットを渡すこと、ポートの概念が登場．伝送を司る各種通信網の品質の差を補完し、透過的なデータ転送を行う
#### プロトコル
##### TCP：Transmission Control Procotol
###### コネクション型、信頼性と順番制御がある、一対一のユニキャストでしかできません、
##### UDP：Uer Datagram Procotol
###### コネクションレス型、リアルタイム性が要求されるアプリ向け、音声配信や動画配信など、途中のパケットが失われても一部が乱れるだけで大きなないアプリに向け
* マルチキャストやブロードキャストを行う通信でトランスポート層を使用する場合には、UDPで通信が必要（RIP2、OSFP、DHCPなど）
#### ウェルノウンポート
##### サーバ側では一般に、とのポート番号を使うかアプリごとに決め、クライアント側はランダム．サーバ側でよく使われるの0〜1023
###### TCP WellKnown
* 20：FTP−data
* 21：FTP−control
* 22：ssh
    * SSH Remote Login Procotol
* 23：telnet
* 25：smtp
    * Simple Mail Transfer Procotol
        * 設計当初はMSA→メールサーバではなく、MTA間の通信
* 53：dns
    * Domain Name Server
* 80：http
    * World Wide Web HTTP
* 110：pop3
    * Post Office Procotol Version 3
* 143：imap
    * Internet Message Access  Procotol
* 179：bgp
    * Border Gateway Procotol
* 443：https
    * HTTP over TLS／SSL
* 465：smtps
    * SMTP over TLS／SSL
        * IEEE対象外
* 587：submission
    * Message Sbumission
        * メール送信推奨．身分認証あり、STARTTLSコマンド（RFC3207）よりTLS／SSLあり
* 989：ftps−data
    * FTP data over TLS／SSL
* 990：ftps−control
    * FTP control over TLS／SSL
* 993：imaps
    * IMAP4 over TLS／SSL
* 995：pop3s
    * POP3 over TLS／SSL
###### UDP WellKnown
* 53：DNS
* 67：bootps
    * Bootstrap Protocol Server（DHCP）
* 68：bootpc
    * Bootstrap Procotol Client（DHCP）
* 69：tftp
    * Trivial FTP
* 123：ntp
    * Network Time Procotol
* 161：snmp
    * Simple Network Manage Procotol
* 162：snmptrap
    * 故障報告用
* 52：router
    * RIP
* 546：dhcpv6-client
* 547：dhcpv6-server
##### 直近のOSでは、動的に割り当てるポート番号は49152〜65535
