# PostgreSQL

## 運用管理

### 標準付属ツール

- 共通

	- −V、−−version
	- −?、−−help

- pg_ctl

	- initdb

		- 裏はinitdbを呼び出している、root不可
		- pgctl init[db]

			- -D、−−pgdata＝データベースクラスタ
			- −o オプション

				- 内部的に呼び出すinitdbに渡すオプションを指定する

	- start

		- −D
		- −t 最大待ち時間

			- デフォルトは60秒
			- 時間内完了しないと、startコマンドが失敗だが、Postgres起動自体は引き続きに行われる

	- stop

		- −D
		- −W 停止が完了するまでで待たない
		- −m シャットダウンモード

			- −s[mart]

				- スマートシャットダウン

					- クライアントからの接続がすべて切断されるまで待ってから停止する。
接続が残っている限り、停止は完了しないため注意すること

			- −f[ast]

				- 高速シャットダウン

					- 強制的に切断してたら停止する、実行中のトランザクションはすべてロールバックする
					- デフォルトオプション

			- −i[mmediate]

				- 即時シャットダウン

					- クリーンアップ処理を行わずに緊急停止、クラッシュした状態と同様

						- 緊急時やPostgreSQLのクラッシュを模擬する場合のみに使うこと

		- −t

	- restart

		- −D
		- −m
		- −t

	- reload

		- −D

			- pg_hba.confや一部パラメータ設定をリロードする

				- 既に接続が確立しているセッションには効果なし

					- 接続済みのセッションを強制的に切断したい場合は、psコマンドなど でPIDを調べ、スーパーユーザでpg_terminate_backend(pid)関 数を実行

	- status

		- −D

	- kill

		- HUP

			- ＝reload

		- TERM

			- ＝smart stop

		- INT

			- ＝fast stop

		- QUIT

			- ＝immediate stop

- PostgreSQL接続

	- データベースユーザ

		- 主な権限

			- CREATEUSER
			- CREATEDB
			- SUPERUSER
			- LOGIN
			- REPLICATION

	- createuser

		- −P、−−pwprompt

			- パスワードを設定する

		- −s、−−superuser

			- スーパーユーザ権限を設定する

				- スーパーユーザだけスーパーユーザが作成可能

		- −S、−−no−superuser

			- スーパーユーザ権限を設定しない（デフォルト）

		- −d、−−createdb

			- データベースの作成権限を設定する

		- −D、−−no−createdb

			- データベースの作成権限を設定しない（デフォルト）

		- −r、−createrole

			- ユーザの作成権限を設定する

		- −R、−−no−createrole

			- ユーザの作成権限を設定しない（デフォルト）

		- −l、−−login

			- ログイン権限を設定する（デフォルト）

		- −L、−−no−login

			- ログイン権限を設定しない

		- −−interactive

			- 対話的に設定する場合に指定

		- −e、−−echo

			- createuserが実行したSQLを出力

		- オプション指定しない場合は、対話的に作成

			- ←❗️PostgreSQL12で検証する際に、デフォルト権限で作成される

				- 対話できに欲しいであれば、−−interactiveオプションを追加

	- dropuser

		- −i、−−interactive

			- ユーザを削除して良いか削除前に確認する

				- スーパーユーザに削除にはスーパーユーザ権限が必要

					- ←最後の一個は削除不可にする❓

	- createdb

		- 指定した名前のデータベースを作成する、名前指定しない場合場合、createdbの実行するOSユーザと同じ名前のデータベースを作成する
		- −O、−−owner＝ユーザ名

			- データベースの所有者となるユーザを指定する

				- スーパーユーザでないのcreaterole権限が持っているユーザは自分のみ指定可能

		- −E、−−encoding＝エンコーディング
		- −l、−−locale＝ロケール
		- −T、−−template＝データベース名

	- dropdb

		- −i、−−interactive

			- データベースを削除して良いか削除前に確認する

				- スーパーユーザ又はデータベースの所有者のみ可

					- createdb権限と関係ない

	- createlang／droplang

		- PostgreSQLで使う手続き言語の定義／削除コマンド

	- vacuumdb

		- データベースに対するVACUUM処理

	- libpq

		- PostgreSQLに接続するクライアントのためのライブラリー

	- psql

		- 接続オプション

			- −h、−−host＝ホスト名

				- 指定しないと＄PGHOSTを利用、も設定されていない場合はUNIXドメイン　がつかわれる

			- −p、−−port＝ポート番号

				- 指定しないと＄PGPORTが利用され、もない場合デフォルト5432

			- −U、−−username＝ユーザ名

				- 接続する時に使うデータベースユーザ名、指定しない場合＄PGUSERが使われる、も設定されない場合、ツールを実行したOSユーザ名が使われる

			- −d、−−dbname

				- 指定しないと$PGDATABASEを利用

		- 主なオプション

			- −l、−−list

				- データベースの一覧を表示し、psqlを終了する	

					- メタコマンドの＼lと同じ効果

			- −c、−−command＝“コマンド”

				- 指定したコマンドを実行する。実行結果の表示後、psqlを終了する

			- −f、−−file＝ファイル名

				- 指定したファイルからコマンドを読み込み、実行する。実行結果を表示後、psqlを終了する

			- −d、−−dbname＝データベース名

				- 接続するデータベースの名前を指定する、−dを省略する場合は最初の引数がdbnameとして扱われる

		- 接続先データベースの情報は、接続オプションとデータベース名で指定する、未指定の場合は、接続に使うユーザと同じ名前のデータベースに接続する

			- 一般ユーザ

				- ユーザ名＝＞

			- スーパーユーザ

				- ユーザ名＝＃

		- SQLコマンドの入力

			- 改行ではなく、「;」（セミコロン）をSQLコマンドの終わりとして判断する

		- メタコマンド

			- ＼q（＼quit）

				- psqlを終了する

			- ＼l（＼list）

				- データベースの一覧を表示する、＝psql −l

			- ＼d パターン

				- 指定したパターンに名前が一致するテーブル、インデックス、ビュー、シーケンスの構成情報を表示
				- パターンはワイルドカードが使える（＊、？）

			- ＼d

				- テーブル、ビュー、シーケンの一覧を表示する

			- ＼du

				- データベースユーザの一覧を表示する

			- ＼dn

				- スキーマの一覧を表示する

			- ＼dt

				- テーブルの一覧を表示する

			- ＼di

				- インデックスの一覧を表示する

			- ＼dv

				- ビューの一覧を表示する

			- ＼ds

				- シーケンスの一覧を表示する

			- ＼dS

				- システムカタログの一覧を表示する

			- ＼df

				- 関数の一覧を表示する

			- ＼dp

				- テーブル、ビュー、シーケンスの一覧、それらに設定されているテーブル単位の権限を表示する

			- ＼z

				- ＼dpの別名

			- ＼copy

				- PostgreSQLとpsqlの間でテーブルデータをコピーする

			- ＼password ［ユーザ名］

				- 指定したデータベースユーザ（デフォルトは現在のユーザ）のパスワードを変更する

			- ＼c（＼connect）　データベース名

				- 既存の接続を切断して、指定したデータベースに新規接続する

			- ＼i ファイル名

				- ファイルのスクリプト実行

			- ＼o ファイル名

				- 実行結果をファイルに出力

			- ＼x

				- 結果の表示形式を拡張モード（結果の一行を複数行に分けて表示するモード）に変更する。再度＼xを実行することで、元の表示形式に戻る

			- ＼？

				- メタコマンド・ヘルプの一覧を表示する

			- ＼h ［SQLコマンド］（＼help）

				- 指定したSQLコマンのヘルプ情報を表示する。SQLコマンドが魅しての場合、SQLコマンドの一覧を表示する

			- ＼！［コマンド］

				- OSコマンドの実行

			- ＼timing［on|off］

				- クエリ実行時間表示のon/off

		- スクリプトの利用

			- psql実行時にリダイレクト
			- \i
			- psql起動時に、-eオプションをつけると、スクリプトのSQL分がターミナルに表示

				- 起動後に次のメタコマンド設定も可能

					- \set ECHO ALL
					- \set ECHO_HIDDEN

		- コメントの扱い

			- −−コメントは、ターミナルに表示されない
			- /*...*/コメントは、ターミナルに表示

### 設定ファイル

- 共通

	- 一行ずつ、複数行に分けて１つのパラメータを設定することはできない
	- パラメータ名と設定値の間のイコール（＝）は省略できる、パラメータ名と設定値の間には、少なくとも一つの空白がなければならない

		- 文字列の設定値はシングルクォートで囲む

	- 空白の行は無視され
	- シャープ♯スタートはコメント、行の途中でも置くことができる
	- パラメータ名は、大文字／小文字を区別しない
	- 未設定のパラメータでは、自動的にデフォルト値が設定値として使われる
	- 単位

		- 書かないと、デフォルトの単位が適用され
		- メモリ

			- kB

				- キロバイト

			- MB
			- GB

		- 時間

			- ms
			- s
			- min
			- h
			- d

- 設定できる型

	- 論理値（Boolean）

		- on,off,true,false,yes,no,1,0

			- 接頭文字（t,f,y,n）も論理値として使える
			- 大小文字の区別はありません

	- 整数（Integer）
	- 浮動小数点（floating point）
	- 文字列（string）
	- 列挙型（enum）

- 反映のタイミング

	- 不可（internal）

		- ユーザが設定変更できないパラメータ、SHOW文で設定値を確認できる

	- 起動（postmaster）

		- 再起動が必要

			- postgresql.confで“＃（change requires start）”とコメントされている

	- 再読込（signhup）

		- pgctl reloadが必要

	- スーパーユーザのみ（suset）

		- PostgreSQLの起動、pg_ctl reloadによる設定値の変更に加えて、スーパーユーザによるSET文で設定値を変更できるパラメータ

	- いつでも（user）

		- PostgreSQLの起動、pg_ctl reloadによる設定値の変更に加えて、スーパーユーザ及び一般ユーザによるSET文で設定値を変更できるパラメータ

- 設定例

	- 接続

		- listen_addresses

			- クライアントからの接続を監視するPostgreSQL側のIPアドレスを設定する

				- 複数指定可能、設定しないとTCP／IP接続不可、localのみになる

					- 空（’’）に設定してもUNIXドメイン接続は常に待ち受ける

				- 複数指定する場合は、カンマで区切る
				- デフォルトはlocalhost（ループバックアドレス）
				- 再起動必要

		- port

			- クライアントからの接続を受け付けるポート番号を設定する

				- デフォルトは5432
				- 再起動が必要

		- max_connections

			- PostgreSQLに同時接続可能な最大数を設定

				- デフォルトは100
				- 再起動が必要
				- 同時に接続数が設定値を超えると次の接続エラーが発生し、接続は拒否される

	- 接続デフォルト

		- search_path

			- スキーマ検索パスである、デフォルトは”$user”,public
			- いつでも反映できる

		- timezone

			- タイムスタンプ解釈用の時間帯

		- default_transaction_isolation

			- パラメータ型

				- 列挙値

					- read uncommitted
					- read committed
					- repeatable read
					- serializable

			- デフォルト値

				- read committed

			- いつでも反映できる

		- client_encoding

			- デフォルト値SQL_ASCII

				- この場合、クライアントとデータベース間の自動的な文字の変換は行われません

			- いつでも反映できる

	- エラー報告とログ取得

		- log_destination

			- デフォルトstderr

				- 複数指定する場合はカンマで区切る

			- 再ロードで反映できる
			- stderr

				- サーバログを平文で標準エラー出力に出力する

			- csvlog

				- サーバログをCSV形式で標準エラー出力に出力する

					- logging_collectorをonに設定しないと出力しない

			- syslog

				- サーバログをsyslogに出力する

			- eventlog

				- サーバログをeventlogに出力する（Windows用）

		- logging_collector

			- stderr/csvlogで出力されたログをリダイレクト

				- デフォルトoff

					- postgresql-12ではデフォルトon
					- この設定がonにすると、「postgres: logger」のプロセスが起動する

						- log_rotation_age

							- ログファイルの最大寿命（ファイル切り替え間隔）を指定する

								- 単位

									- デフォルトは分

								- デフォルト値

									- 1d

								- 0を指定すると切り替えなし
								- リロードで変更可能

						- log_rotation_size

							- ログファイルの最大サイズを指定

								- 単位

									- デフォルトはkB

								- デフォルト値

									- 10MB

								- 0を指定すると切り替えなし
								- リロードで変更可能

			- 再起動が必要

		- log_directory

			- デフォルト$PGDATA/log
			- 再ロードが必要

		- log_filename

			- デフォルトpostgresql-%Y-%m-%d_%H%M%S.log

				- strftimeが利用可能な変換識別子であれば利用できる

			- 再ロードが必要

		- log_connections

			- クライアントの接続認証をログに出力

				- デフォルトoff

		- log_min_messages

			- デフォルトWARNING
			- スーパーユーザのみ設定反映できる（suset）
			- 設定した深刻度以上のメッセージだけを出力され
			- 主なレベル

				- PANIC

					- 致命的なエラーが発生したこと、すべてのセッションが強制的に切断され、PostgreSQLは停止する

				- FATAL

					- 特定のセッションで問題が発生したことを示す、そのセッションだけ切断され、他のセッションへの影響は無

				- LOG

					- データベースの管理者が着目すべきPostgreSQLの動作ログを意味する

				- ERROR

					- 特定のトランザクションで問題が発生したことを示す、そのトランザクションだけアボートされ、ほかのセッションやトランザクションへの影響は無い

				- WARNING

					- 想定外の動作に対する警告メッセージ

		- log_line_prefix

			- デフォルト値%m[%p]
			- 再ロードで反映できる
			- 主な設定値

				- %u

					- データベースユーザ名

				- %d

					- データベース名

				- %p

					- プロセスID

				- ％c

					- セッションID

				- ％x

					- トランザクションID

						- トランザクションではない場合は0

				- %t

					- タイムスタンプ（年月日時分秒）

				- %m

					- ミリ秒付きタイムスタンプ（年月日時分秒.ミリ秒）

				- %%

					- %の文字そのもの

	- リソース制限

		- shared_buffers

			- 共有バッファとして使用するメモリサイズを指定する 他のサービスがなければ物理メモリサイズの２５％程度
➔
OSのディスクキャッシュも期待できるので、あまり大きくしない

				- 大きい値を指定したい場合、OSカーネルパラメータ変更要
				- 再起動が必要

		- work_mem

			- バックエンドがクエリ処理中に使用するヒープメモリ量を指定する
➔
ソートやハッシュ結合などで使われるメモリ

				- インスタンス全体の制限でなく、個々の処理での上限なので注意！
➔
大きくしすぎるとOut-of-Memoryが発生する

					- postgresql.confの設定は小さめを推奨
➔
バッチ処理などのセッションで個別にSET文で増やす

		- checkpoint_segments

			- チェックポイント間で出力できる最大WALセグメント数を指定する この設定が小さいと頻繁にディスク書き出しが発生し性能が低下する 最初は「10」程度に設定し、様子を見て調整する 大きくしすぎると、$PGDATA/pg_xlogが肥大化するので注意

				- デフォルトは3
				- リロードで変更可能

		- wal_buffers

			- WAL出力用バッファのサイズを指定する １トランザクションが生成するWALのサイズより大きくする

				- デフォルトは64kB

					- psql12では4MB

				- リロードで変更可能

	- 設定と確認

		- SET

			- SET [LOCAL] パラメータ名　{ TO | = } { 設定値 | DEFAULT }

				- 設定値：数値や論理値、列挙値でない場合はシングルクォートで囲む

					- セッション中実行、影響範囲もセッションのみ

		- SHOW

			- SHOW { パラメータ名 | ALL }

				- セッション中でSHOW文を実行すると現在の設定値を参照できる
				- pg_settingsビュー

					- パラメータの設定値だけでなく、データ型や変更に関する制限、設定 経緯（設定ファイル・環境変数・SET文など）も分かる

	- クライアント認証

		- pg_hba.conf

			- 書式

				- local データベース名　ユーザ名　認証方式
				- host データベース名　ユーザ名　CIDRアドレス　認証方式
				- host データベース名　ユーザ名　IPアドレス　ネットマスク　認証方式

			- 共通

				- postgresql.confと違うところ

					- フィールド内に空白を含めるときは、設定値をダブルクォート（“）で囲む
					- 設定変更すると、pg_ctl reloadで再読み込める

				- 先頭行から順に調べて、マッチする組み合わせが見つかったところで終了 

					- マッチする組み合わせが見つからなければ、接続拒否

			- 接続方式

				- local

					- UNIXドメイン接続に対応する。UNIXドメインを使って接続するくらいんあんとを認証したい場合は、localを接続方式に指定する

				- host

					- TCP／IP接続に対応する。TCP／IP接続を使って接続するクライアントを認証した場合は、hostを接続方式に指定する

			- データベース名

				- allはすべてのデータベースに一致する。カンマ（，）区切りで複数指定することもできる

			- ユーザ名

				- allはすべてのユーザに一致する。カンマ（，）区切りで複数指定することができる

			- CIDRアドレス

				- 許可するクライアント側のアドレスであることを注意

					- ネットマスク方式にも使える

			- 認証方式

				- trust

					- 接続を常に許可する

				- reject

					- 接続を常に拒否する

				- md5

					- 接続に対してパスワード認証を行う。MD5で暗号化されたパスワードを、認証時にクライアントに要求する

				- peer

					- クライアントのオペレーティングシステムにおけるユーザ名をオペレーティングシステムから取得し、ユーザ名が要求されたデータベースユーザ名と一致するか検査します。 これはローカル接続の時にのみ使用可能です

				- ident

					- クライアントのオペレーティングシステムにおけるユーザ名をクライアント上のidentサーバに尋ねてユーザ名が要求されたデータベースユーザ名と一致するか検査します。 ident認証は、TCP/IP接続でのみ使用可能です

				- scram−sha−256

					- 接続に対してパスワード認証を行う。md5と類似の方法だがより堅牢な認証を行う。現在のおすすめである

				- password

					- 接続に対してパスワード認証を行う。平文ので通信が盗みされる可能性があるため推奨しない

				- その他

					- LDAPサーバ
					- RADIUSサーバ
					- cert：SSLクライアント証明書
					- pam：OSのPAMサービスを使用した認証
					- gss

						- TCP/IP接続を使用する時のみ利用可能、GSSAPIを使用する

					- sspi

						- SSPIを使用する、Windowsのみ利用可能

### バックアップとリストア

- 稼働中のバックアップ

	- pg_dump

		- データベースを指定してバックアップ

			- pg_dump [接続オプション] [-Fp | -Fc | -Ft] [-f ファイル名] [データベース名]

				- -Fp

					- 平文方式、-Fの指定がない場合のデフォルト

						- psqlコマンドで読み込むことができるため、異なるOSやバージョン間でのデータ移行はよく使われる
						- フォーマット指定していない場合のデフォルト

				- -Fc

					- カスタマイズ、独自のバイナリ形式

				- -Ft

					- tar形式

				- -f

					- バックアップ先のファイル名を指定する、省略した場合は標準出力となる（｜よりリダイレクトにもよく使われる）

		- データベース単位

	- pg_dumpall

		- すべてのデータベース、データベースクラスタ全体をバックアップ。データベースユーザや、データベース全体に適用するアクセス制限など、すべてのデータベースに共通するグローバルオブジェクトにもバックアップとして取得できる

			- pg_dumpall [接続オプション] [-f ファイル名]
			- 通常、スーパーユーザで実行する

		- ユーザ情報を含むデータクラスタ全体

			- 設定ファイルは別途バックアップしておく必要

- 稼働中のリストア

	- 平文形式

		- psql

			- psql [接続オプション] [-f ファイル名]

	- 平文以外

		- pg_restore

			- pg_restore [接続オプション] [オプション] [-d データベース名] [ファイル名]

				- -jオプション、リストア時間を高速化するためにつかえる
				- -d オプションでデータベース名を指定しなかった場合は、平文形式のSQLコマンドで標準出力に出力され

- 非稼働中

	- 物理バックアップ／オフラインバックアップ／コールドバックアップ

		- $PGDATA丸ごとまたはdataフォルダをバックアップ取る

			- 例：tar cvf backup.tar data

		- rsyncやtarコマンドの利用が一般、ストレージスナップショット機能にも使える

			- 設定ふぁいるを含め丸ごとのバックアップ

				- 別マシンにリストア可能だが、同じメジャーバージョンが必要です

	- PITR（Point In Time Recovery）

		- データベース全体のバックアップに加えて、PostgreSQLの運用中にアーカイブとして記録された更新データを元にデータベースをリカバリする機能

			- ベースバックアップ

				- pg_start_backup()関数／pg_stop_backup()関数によるバックアップ

			- 変更の記録

				- 先行書き込みログ／WAL（Write Ahead Logging）

					- アーカイブWAL
					- 未アーカイブWAL

						- WALファイル

							- 16MBのファイル、変更内容を記録

		- 設定

			- wal_level

				- WALに書き込まれる情報の度合いを指定する。
				- デフォルトreplica

					- minimal
					- replica
					- logical

			- archive_mode

				- WALアーカイブを有効にするかどうかの指定
				- デフォルトはoff

					- PITRはonに必要

			- archive_command

				- WALファイルをWALアーカイブとしてコピーするためのシェルコマンドを指定

					- 例：archive_command = ‘cp %p /mint/archivedir/%f’

		- ベースバックアップ

			- pg_start_backup()関数を呼び出した後、データベースクラスタのディレクトリを丸ごとバックアップし、pg_stop_backup()を呼び出す

				- スーパーユーザで操作する必要がある

					- pg_start_backup(‘ラベル名’)
					- pg_stop_backup()
					- pg_switch_wal()

						- 新しいWALファイルへ強制移行する

				- 実行例

					- psql -c “SELECT pg_start_backup(‘label’, true);”
					- tar czvf /mnt/backup.tar.gz data
					- psql -c “SELECT pg_stop_backup()”

			- version9.1以降ではpg_basebackupコマンドでベースバックアップを取る

		- リカバリ

			- 手順

				- ①ベースバックアップのリストア

					- 使用例

						- pg_ctl status

							- PostgreSQLが停止していることを確認

						- tar xzvf /??/backup.tar.gz

							- ベースバックアップをdataへ展開

					- PostgreSQLを停止した状態で現状のデータベースクラスタを別のディレクトリに移動し、$PGDATAディレクトリがない状態からリカバリを開始する

						- インスタンスが稼働している場合は停止
						- $PGDATA/pg_xlogの中身を安全な場所に退避（※）➔障害直前に変更内容はここにしかないので忘れずに！
						- データベースクラスタを退避または削除
						- $PGDATA/pg_xlogの中を全て削除し、そこに（※）をコピー

				- ②未アーカイブのWALファイルをコピー

					- 使用例

						- ls /mnt/archivedir
						- rm -rf $PGDATA/pg_wal
						- cp -r /mnt/data/pg_wal $PGDATA

				- ③recovery.confの設定、PostgreSQLの起動

					- 当該ファイルが存在すると、PostgreSQLを起動すればリカバリが始まり

						- pg_hba.confを編集して一般ユーザの接続を拒否

							- リカバリ完了後、pg_hba.confを元の設定に戻して設定をリロード

						- リカバリの終了後、recovery.doneという名前のファイルにリネームされ

					- 記述例：

						- restore_command = ‘cp /mnt/archivedir/%f %p’

							- WALアーカイブからWALファイルとしてコピーする

						- recovery_target_timeなど
						- インストールディレクトリのshare/recovery.conf.sampleがある

- COPY

	- サーバ側のファイルへデータをコピーしたり、ファイルのデータをテーブルへローディングしたり

		- COPY テーブル名 TO {‘絶対パスのファイル名’ | STDOUT} [[WITH] (オプション [, ...])]
		- COPY テーブル名 FROM {‘絶対パスのファイル名’ | STDOUT} [[WITH] (オプション [, ...])] 

	- 絶対パス指定、スーパーユーザ権限か、あるいはデータベースサーバ上のファイルへの読み書きが可能なデフォルトロール権限を持つユーザ権限が必要

		- pg_read_server_files
		- pg_write_server_files

- \copy

	- psql接続のクライアントで動作、スーパーユーザ権限は必要ない、ファイルパスも絶対パスと相対パスの何方でも構いません

		- \copy テーブル名 from|to {ファイル名 | stdin} [with] [delimiter [as] ‘区切り文字’] [csv [header]]

### 基本的な運用管理

- ユーザ管理

	- createuser [option] [username]

		- オプションで指定しなかった場合、以下を対話的に入力する。
­ ・新規ユーザ名
・新規ユーザを管理者ユーザとするかどうか 
・ 新規ユーザにデータベース作成の権限を与えるかどうか
・新規ユーザにユーザ作成の権限を与えるかどうか

	- dropuser
	- ALTER USER

		- 変更できる内容はcreateuserと同じ：パスワード初期化など
		- ALTER USER ユーザ名 [[WITH]
  SUPERUSER | NOSUPERUSER
| CREATEDB | NOCREATEDB
| CREATEROLE | NOCREATEROLE
| LOGIN | NOLOGIN
| PASSWORD ‘パスワード’
| VALID UNTIL ‘日付’]

- VACUUM、ANALYZE

	- バキューム（VACUUM）

		- 複数のユーザからトランザクションを同時に実行するため、MVCC（Multi−Version Concurrency Control：他版型同時実行制御）の仕組みがある。PostgreSQLのMVCCは追記型で、不要領域の回収が必要となり

			- MVCC

				- SELECTと同時のUPDATEは競合しないような仕組み

		- VACUUM [FULL] [VERBOSE] [テーブル名]

			- 指定したテーブルのインデックスも含めて不要領域を回収、物理的な削除ではありません
			- FULL

				- テーブルの内容を新しいファイルに書き換えて、不要領域を物理的にディスクから削除される
				- 実行中は対象のテーブルを排他ロックする
				- 大量のデータ削除によりディスク領域の大半が不要領域になっている場合に使用、定期的に実行するものではない

			- VERBOSE

				- 実際に回収した不要領域量などを知ることができる

			- テーブル

				- 指定しないと、データベース内のすべてのテーブルに対して実行

			- パラメータ指定しないと、現在接続中のデータベースの全テーブルがVACUUMの処理対象となる

	- ANALYZE

		- SQLを効率的に実行できるためのテーブル統計情報を更新する
		- ANALYZE [テーブル名]

			- テーブル名を省略する場合、すべてのテーブルが対象

	- VACUUM ANALYZE

		- まとめて実行

	- 自動バキューム

		- postgresql.conf

			- autovacuum

				- Ver8.3以降デフォルトはon
				- 8.1以降ではインスタンス内にVACUUM実行専用のプロセスがあり、 一定以上の割合で更新されたテーブルを自動的にVACUUMする ➔ ANALYZEも同時に実行される

		- 定期実行ではなく、データベース内の不要領域の割合が多くなったテーブルに対して必要に応じて実行

	- OSコマンド

		- vacuumdb −Z|--analyze-only [接続オプション] [--t|--table='テーブル名'] [データベース]

			- オプション補足

				- -z|—analyze

					- ANALYZEと合わせて実施

				- -f|—full

					- 不要領域回収後、ファイルを切り詰め

- システム情報取得関数

	- version()
	- current_datebase()

		- 現在接続しているデータベース

	- current_userとuser

		- 現在のユーザを確認、かっこがないのは歴史問題

- 情報スキーム

	- SQLの標準規格で規定されているデータベースクラスタ全体に関わる各種の情報

		- infomation_schema

			- データベース内のテーブルや列、ユーザなどの様々な情報定義が格納され

				- .tables

					- 調査できるテーブルは、現在接続中のデータベースに含まれているテーブルだけです。

			- 例

				- SELECT * FROM information_schema.enabled_roles;
				- SELECT * FROM information_schema.tables;

- システムカタログ

	- DBMS固有、PostgreSQL固有、より詳細な情報を取るにはこれを使う、データベースに関する内部情報を格納したテーブルです

		- pg_catalogスキーマ

			- 例

				- /du	

					- SELECT * FROM pg_roles WHERE rolcanlogin IS TRUE

						- pg_rolesはpg_authidのrolpasswordが隠されたビュー

				- pg_settings

					- SHOW文で扱うようなパラメータ設定を参照できる

				- pg_datebase

					- データベースごとではなく、各データベースクラスに１つ存在する

				- pg_tables

					- スキーマ名、テーブル名、所有者、インデックス有無など
					- schemaname

						- ユーザが作成したテーブルを調査するのはpublicを使用

- 権限

	- GRANT	

		- GRANT {{SELECT | INSERT | UPDATE | DELETE | TRUNCATE | REFERENCES | TRIGGER} [, ...] | ALL [PRIVILEGES]}
ON {[TABLE] テーブル名 [, ...]}
TO {ユーザ名 | PUBLIC} [, ...] [WITH GRANT OPTION]

			- テーブル、行、列単位それぞれ設定可
			- WITH GRANT OPTION

				- TOの対象ユーザがこの権限を別のユーザに設定できる

			- 条件指定のUPDATE、DELETE等には条件があるため、実行するためにまずSELECT権限を持つが必要
			- INSERT INTO → COPY FROM 権限
			- SELECT → COPY TO 権限
			- テーブル・ビューの主な権限

				- SELECT/INSERT/UPDATE/DELETE/TRUNCATE

					- SQL文を実行可能
					- SELECT/INSERT/UPDATEは列単位で指定可能

				- REFERENCE

					- 外部キーで参照可能（参照元テーブルにもこの権限が必要） 列単位で指定可能

				- TRIGGER

					- トリガーを作成可能

				- ALL

					- 全ての権限を一括で付与/剥奪

			- データベースの主な権限

				- CONNECT

					- データベースに接続が可能

				- CREATE

					- データベース内にスキーマを作成可能

			- スキーマの主な権限

				- USAGE

					- スキーマ内のオブジェクトへのアクセスが可能

				- CREATE

					- スキーマ内にオブジェクトを作成可能

			- シーケンスの主な権限

				- USAGE

					- currval()およびnextval()の呼び出しが可能

				- UPDATE

					- nextval()およびsetval()の呼び出しが可能

			- デフォルト権限

				- 作成直後のオブジェクトについて、所有者（一般に作成ユーザ）は全 権限を持つが、他のユーザは一切の権限を持たない

					- ALTER DEFAULT PRIVILEGES文であるユーザがこれから作成する オブジェクトのデフォルト権限を変更可能➔既存のオブジェクトの権限は変更されないので注意

						- ALTER DEFAULT PRIVILEGES FOR USER 作成ユーザ名 GRANT 権限 ON オブジェクト種別 TO 付与ユーザ名;
						- ALTER DEFAULT PRIVILEGES FOR USER 作成ユーザ名REVOKE 権限 ON オブジェクト種別 FROM 剥奪ユーザ名;

			- 権限管理の対象ユーザ

				- GRANT文の権限付与対象ユーザに「public」を指定すると、全ての ユーザに権限を一括付与できる

					- public経由で付与した権限は、ユーザ指定では剥奪できず、public 指定で剥奪する必要がある

						- ユーザA以外にアクセスを許可したい、という場合に(1)publicに付与 (2)ユーザAから剥奪、という手順をとってもユーザAはpublicの権限を 経由してアクセス可能なままになる

			- ロール権限

				- GRANT文で権限をロールに付与し、そのロールをユーザに付与できる➔PostgreSQLではユーザとロールは同一のもので区別されない

					- GRANT ロール名 TO ユーザ名 [WITH GRANT OPTION];

						- このとき、ロールの持つLOGIN権限やSUPERUSER権限も同時に付与 されるので注意

			- \dp \z

				- テーブル、ビュー、シーケンスの一覧に権限を表示

					- ユーザ名＝xxxx

						- ユーザに設定された権限

					- ＝xxxx

						- PUBLICに設定されて権限

					- r

						- SELECT

					- w

						- UPDATE

					- a

						- INSERT

					- d

						- DELETE

					- D

						- TRUNCATE

					- x

						- REFERENCES

					- t

						- TRIGGER

					- arwdDxt

						- フル権限（テーブル用）

					- /yyyy

						- この権限を設定したユーザ

			- \du+

				- ユーザ一覧に権限を表示

			- \dn+

				- スキーマ一覧に権限を表示

			- \ddp

				- デフォルト権限の一覧を表示

	- REVOKE

		- REVOKE {{SELECT | INSERT | UPDATE | DELETE | TRUNCATE | REFERENCES | TRIGGER} [, ...] | ALL [PRIVILEGES]}
ON {[TABLE] テーブル名 [, ...]}
TO {ユーザ名 | PUBLIC} [, ...] 

## データベースクラスタ

### 格納領域

- $PGDATA

	- PG_VERSION

		- PostgreSQLのメジャーバージョン番号を記録したファイル

	- base

		- 各データベースのサブディレクトリを格納するディレクトリ

			- サブディレクトリの名前は対応データベースのOIDを使っている

	- global

		- データベース間で共有するデータ（ユーザ情報など）を格納するディレクトリ

	- log

		- ログファイルを格納するデフォルトのディレクトリ

	- pg_wal

		- トランザクションログ（WAL）を格納するディレクトリ

	- postgresql.conf

		- パラメータを設定するファイル

	- pg_hba.conf

		- クライアントの認証情報を設定するファイル

	- postmaster.pid

- 制限事項

	- PostgreSQLサーバとデータベースクラスタは一対一
	- 複数のPostgreSQLサーバを起動させ、それぞれ別のデータベースクラスタは可能

		- ❗️一つのサーバ内に複数作成可能だが、インスタンスごとに一つ

### 初期状態

- template0

	- テンプレート、作成後改変は不可、エンコードやロケションを指定して作成は可能

- template1

	- デフォルトのテンプレート、初期はtemplate0と全く同じ、作成後変更可能

		- CREATE DATABASEのデフォルトコピー元

- postgres

	- 標準付属ツールがデフォルトの接続先として使うデータベース、通常DBとして使える

### initdb

- −D、−−pgdata＝ディレクトリ名

	- データベースクラスタ作成するディレクトリを指定する、未指定の場合は、環境変数PGDATAが使われる

- ｰE、−−encoding＝エンコーディング

	- エンコーディングを指定する、未指定の場合、OSのロケールから自動的に決定する。

		- サーバエンコーディング

			- UTF−8、EUC_JPなど

		- クライアントエンコーディング

			- UTF−8、EUC_JP、SJISなど

- −−locale＝ロケール

	- ロケールを指定する、未指定の場合は、OSのロケールが使われる

		- 全角数字を数値順でソートされたい場合がある

- −−no−locale

	- ロケールを無効にする（−−locale＝Cと同じ意味）

		- ←推奨、性能面の考慮

- −U、−−username＝ユーザ名

	- 作成するデータベースのスーパーユーザの名前を指定する。未指定の場合、PostgreSQLの管理ユーザと同名になる

- -g、--allow-group-access

	- クラスタの所有者と同じグループのユーザがクラスタ内 のファイルを読めるようになります。 これは非特権ユーザとしてバックアップを実行するのに有用です。

		- デフォルトでは実行ユーザのみ権限が持っている

## インストール

### configure make  install/uninstallなど

### インストーラを使ったインストール

- ビルド済みのパッケージをダウンロード
- GUIの管理ツールpgAdmin Ⅲなど
- ソースコードインストールとの違い

	- パッケージインストール中にpostgresユーザを自動的に作成
	- デフォルトではPostgreSQLのbinフォルダをパスに追加しない

		- initdbやpg_ctlを利用したい場合は

			- service postgresql-{version} [initdb]
			- 最新ではsystemctlを利用

### パッケージ管理システムを使ってのインストール

### 設定

- PATH、LD_LIBRARY_PATH

## クライアントサーバ構成

### サーバ

- マルチプロセス構成

	- postgres(postmaster)

		- クライアントからの接続を待ち受ける、すべてのプロセスの親プロセス

			- つまり、接続の最初の認証も実施する

	- postgres backend

		- ­postgresプロセスによって起動され、クライアントからの処理を担当

			- セッション毎にbackendプロセスが起動され、クライアントと1対1対応する

	- writer

		- 共有バッファのデータをディスクに書き込むプロセス
		- チェックポイントやダーティバッファの書き込み

	- wal writer

		- データの変更履歴を WALファイルに書き込む

	- status collector

		- 実行時統計情報を収集する

	- logger

		- PostgreSQLサーバ実行時のログを記録するプロセス
		- パラメータ設定により有効化し、何をどこに保存するか指定できる

	- archive

		- チェックポイント以前の不要なWALをPITRのために別のディスクに退避

	- autovacuum launcher/worker

		- 自動VACUUMを実行

- メモリ領域

	- 共有メモリ

		- shared_buffers

			- ディスクから読み取ったデータをキャッシュして、以降のユーザ要求に高速に応答

		- wal_buffers

			- ログ先行書き込み(Write Ahead Logging)
			- 耐障害性とパフォーマンスを両立するための仕組み

	- セッションメモリ

		- work_mem

			- ソートやハッシュの一時領域

		- maintenance_work_mem

			- メンテナンス操作

- 裏動き

	- セッション開始：postgresプロセスが認証を担当

		- クライアントから認証要求
		- postgresプロセスによる認証後、backendプロセスが起動しセッションを確立

	- 共有バッファを利用

		- ①クライアントからクエリ発行
②backendプロセスが必要なデータを共有バッファから探す
③バッファ上に無い場合は、ディスクの該当ブロックをバッファに載せる
④backendプロセスがクライアントに結果を返却

			- 以降は高速に結果を返す仕組み

	- 共有バッファ上の更新＋WALによる変更履歴の永続化

		- ①クライアントから更新処理を発行(UPDATE、INSERT、DELETE) 
②backendプロセスが必要なデータを共有バッファから探す 
③バッファ上に無い場合は、ディスクの該当ブロックをバッファに載せる 
④変更内容をWALバッファ上のWALレコードとして作成 
⑤共有バッファ上のデータを更新 
⑥クライアントが変更を確定(COMMIT)すると、WALレコードをWALファイルに永続化し、 WAL書き込みが成功したらクライアントに成功を返す

	- 共有バッファ上のデータをデータファイルに書き込む

		- チェックポイントは個々のSQL実行とは非同期に行う

			- チェックポイントはある瞬間バッファの内容を確実にディスクに反映されたを保証するタイミング、大量なIOが発生する
			- 普通は、ダーティバッファの書き込みで、実際の更新と非同期に、システムの負荷を極力抑えて実行される。どこまで書くのは保証はしない

		- チェックポイント以降のWALファイルは非常に重要

			- WAL ⇒ 変更履歴を追跡可能なように都度ディスクに記録
			- チェックポイント以降のWALは、変更履歴を追跡するために必要

		- WALの書き込み

			- COMMITの時、確実にディスクに書き込み、それ以外も一定の時間を経過やWALバッファ不足より書き込みも可能

## 一般知識

### 主な特徴

- OSS

	- PostgreSQL Global Development Group（PostgreSQLグローバル開発グループ）によりコミュニティベースで公開され、開発及び配布が行われている

		- バージョン

			- 9以前

				- x．y．z

			- 10以降

				- x．z

		- マニュアル

			- ソフトウェア同梱

		- 日本ユーザ会

			- 普及促進を目的に、各種セミナー／イベントを企画／運営している

- 長歴史

	- カリフォルニア大学バークレイ→1986→Postgres95→Postgres6.0（1996）→PostgreSQL11（2018）

- 標準SQLの大部分やその他の最新機能をサポート
- ユーザ拡張が可能
- 標準規格対応

	- SQL：2003、SQL：2008、SQL：2011

- ライセンス

	- BSDライセンスをベースにしたライセンス（The PostgreSQL License）

		- 商用／非商用に問わず無償に利用可能
		- 改変も自由、PostgreSQLを組み込んだい場合でも公開義務はない
		- 著作権ひょうじとライセンス条文自身を表示することで配布も可能

- 多国語対応

	- データベースごとに文字エンコーディングを指定できる

- マルチプラットフォーム
- レプリケーション

	- 9↑ホットスタンバイ、ストリーミングレプリケーション
	- 11↑ロジカルレプリケーション

### 基本概念

- DBMS

	- 主な機能

		- データの機密保護

			- 権限管理や暗号化

		- トランザクション制御
		- データの整合性を維持
		- 障害からの安全な復旧
		- APのための利用IF提供

- データモデル

	- AP応用情報のDB篇を参照

## 論理バックアップ／オンラインバックアップ／ホットバックアップ

*XMind: ZEN - Trial Version*