# DB

一部詳細化していない部分はAPやPostgreSQLのMindMapを参照

## 1 ．データベース

### データベースの基本

- データモデル

	- 概念データモデル（モデリング）

		- トップダウンアプローチ
		- ボトムアップアプローチ

	- 論理データモデル

		- 階層型（ハイアラキカル）モデル
		- ネットワークモデル
		- 関係（リレーショナル）モデル
		- オブジェクト指向モデル

	- 物理データモデル

		- データベースとDBMSやハードウェアを結びつけ

- 関係モデル

	- リレーション（関係、表）、タプル（行、組）、カラム（列、属性）

- 3値理論

	- 真
	- 偽
	- NULL

		- 不明・未知（Unknown）

			- 演算に含まれると結果はNULLになる

		- 非存在・適用不能（Inapplicable）

			- デフォルトではNULLの行は抽出されない

### システム開発とデータベース

- アプローチ

	- プロセス中心アプローチ（POA：Process Oriented Approach）

		- 図法

			- DFD：Data Flow Diagram
			- 状態遷移図

	- データ中心アプローチ（DOA）

		- 図法

			- E−R図（Entity−Relationship Diagram）

	- オブジェクト指向アプローチ（OOA）

		- 図法

			- クラス図
			- シーケンス図

- その他

	- DA：Data Administrator：データ管理者

		- データベース中にどのようなデータをどれだけ格納するのかを決める人

			- データベース設計などの上流工程

				- データベーススペシャルリストでの中心

	- DBA：DataBase Administrator：データベース管理者

		- データベースを構築し、運用保守も行う、暗号化や個人保護と情報セキュリティの意識が必要な人

			- DAの次、物理設計や運用保守などの下流工程をDBAが行い

### データ分析とデータベース

- BI（Business Intelligence：ビジネスインテリジェンス）
- OLTPとOLAP

	- OLAP：Online Analytical Processing

		- 従来のOLTPのデータ、つまり関係データベースなどのデータのスナップショットを撮り、別のデータベースに移り、その時に多次元データとして再構成し、様々な次元（分析軸）で分析できるようにする

- データウェアハウス

	- 意思決定のため、目的別に編成され統合された時系列で、削除や更新を行わないデータの集合体

- データマイニング（DM：Data Mining）

	- 統計学やパターン認識、AIなどのデータ解析の技法を大量のデータに適用することで新たな知識を取り出す技術です

- ビッグデータとAI

	- ビッグデータの特徴

		- データの量（Volume）
		- データの種類（Variety）
		- データ発生／処理の頻度／速度（Velocity）

	- AI（Artificial Intelligence：人工知能）

		- データクレンジング

			- AIに学習させるためのデータを作成するときには、データの重複や誤記、表記の揺れなどを探し出し、削除や修正、正規化などを行う、事前にデータの品質を高めるの作業

## ２．基礎理論

### 正規化

- 目的

	- 更新時異状を排除する（挿入、更新、削除）→1か所1事実（1 fact  1  place）を実現できる

- 正規化を行わない場合

	- データの更新を行わないもの
	- データの履歴を残すもの
	- 高速化が特別に必要なもの

- 正規化手法

	- 関数の従属性

		- ある属性セットXの値が決まれば、別の属性セットYの値が一意に決まる、表記はX→Y

	- 導出属性の排除

		- 導出属性：他の属性から演算を行うことによって導くことができる属性（例：単価✖️数量＝金額）
		- 更新可能性、履歴や性能面の考えでどこまで正規化する

	- 情報無損失分解

		- 分解した関係をしぜん結合した時に元に戻せる分解の仕方

	- メタデータ

		- データそのものの他に、データについてのデータであるメータデータがある

			- 例：関係　商品（番号、商品名）に対して、「番号、商品名」に対する“属性名”、商品に対する“関係名”がメタデータになる
			- データモデルの定義では、このメタデータをメタ属性として扱い、属性の一つとすることがある

- 正規形

	- 第１正規形

		- シンプルなドメイン上定義された関係

			- シンプルなドメイン：属性がすべて単一値をとること

				- 直積集合や冪集合の排除

					- 直積集合（direct  product）

						- 集合の集まりで、各集合を組にしたものです

							- ←一つのドメイン（マス目）の中に複数の値が入っており単一値ではないもの

					- 冪集合（power set）

						- 与えられた集合から、その部分集合を元として含む集合のことです

							- ←一つの値に対して複数の値（集合）が対応するような関係　（繰り返しか、重複のイメージ）

		- 属性が単一値になればいいだけなので、表を分解する必要がない
		- 問題点

			- タプル挿入時異常

				- 主キー規定しないと挿入できない

			- タプル更新時異常

				- 重複更新

			- タプル削除異常

				- データが失う可能性

	- 用語

		- 候補キー（candidate key）

			- 関係（リレーション）のタプルを一意に識別できる属性または属性の組のうち極小のもの

				- 一つとは限りません

			- 第２、第３正規形への正規化は、主キーではなく、候補キーを正規化の定義を用いる

		- 非キー属性

			- 候補キーの反面、複数の候補キーのそれぞれに対して、それぞれの候補キー以外の属性はこの候補キーの場合の非キー属性

				- 候補キーを選定しないと非キー属性は取れない

					- 特定の候補キーに対して特定の非キー属性が出る

		- 主キー（primary key）

			- 候補キーの中から一つを選んだもの

				- 主キー制約：主キーを構成する属性の値は空値（NULL）を取らない

		- 代理キー（alternate key）

			- 主キーに選べなかった候補キー

		- スーパキー

			- 関係のタプルを一意に識別できるという条件を満たす属性または属性の組のこと

		- 外部キー

			- 複数の関係を結びつけるためのキー

				- 参照制約／外部キー制約という

		- 完全関数従属

			- 関数従属性X→Yにおいて、Xの全ての真部分集合X‘について、X‘→Yが成立しないことを指す

		- 部分関数従属
		- 推移的関数従属

			- 関係Rの異なる属性または属性の集合であるX、Y、Zについて、X→Y、Y!→X、Y→Zの三つの制約が成立している関数従属性である

				- X→Y、Y→Xの場合、XとYは等価の意味、分けても意味がないからです

		- 真部分集合

			- 部分集合のうちの全体集合を除いた集合

	- 第２正規形

		- 関係Rは第１正規形である、かつRの全ての非キー属性はRの各候補キーに完全関数従属している

			- どの候補キーにもはまらない属性である非キー属性について、各候補キーに完全関数従属しているかどうかを確認する

				- 部分関数従属の排除

					- 部分関数従属する候補キーの一部を新たな関係の候補キー（主キー）とし、非キー属性をその関係に移動させる

						- 例{A, B}→Cの場合、B→Cにも成立すると関係分割後、Bは候補キーと外部キーになる

		- 問題点

			- 第１正規形の問題点にも存在

	- 第３正規形

		- 関係Rは第２正規形である、かつRの全ての非キー属性はRのいかなる候補キーにも推移的に関数従属しない

			- 推移的関数従属の排除

				- X→Y→Zの関係において、Y→Zを別の関係にし、Yは元の関係にも外部キーとして残しておく

					- Yが二つ関係で候補キーと外部キーになる

	- 用語

		- 多値従属性

			- ある属性Xが決まったら、別の属性YとZ（複数でも良い）が独立して決まるという性質

				- 表記：X→→Y｜Z

		- 結合従属性

			- 多値従属性の発展形で、関係が三つ以上に分解可能な従属性。関係がn個に分解可能なことを、n−分解可能で表記

				- 従属属性が独立ではなく、関連性がある、この関連性を分けるのは第５正規形分解である

	- 高次元の正規形

		- 情報無損失分解かつ関数従属性保存で問題なく分解できるのは第３正規形まで。高次元の正規形では失われる情報や関数従属性について意識しながら行うが必要
		- ボイスコッド正規形（BCNF：Boyce／Codd Normal Form）

			- 非キー属性という条件をつけず、全ての関数従属性について、部分関数従属性や推移的関数従属性を排除する

				- 定義：関係Rのうち、いかなるX→Yの関数従属性に対して、X→Yは自明な関数従属性であるか、または、XはRのスーパキーである

					- ここのXはRのスーパキーのは、Xはスーパキーの一部ではなく、X自身のみでスーパキーとしてなれる

		- 第４正規形

			- 定義：X→→Yを関係Rの多値従属性とするとき、X→→Yは自明な多値従属性であるか、または、XはRのスーパーキーである

				- X→→Y｜Zの場合、関係を分解し、X→→YをX→→Z別関係に分ける

		- 第５正規形

			- ＊（X1、X2、…、　Xn）を関係Rの結合従属性とするとき、＊（X1、X2、…、　Xn）は自明な結合従属性であるか、または、各XiはRのスーパキーである

### 関係演算

- 和（union）

	- ＋、U

- 差（difference）

	- ー

- 積（共通）（intersection）

	- 

- 直積（direct product）

	- ✖️

- 射影（projection）

	- 関係R（A、B）からAのカラムを取る関係R‘（A）がRの射影

- 選択（selection）
- 結合（join）

	- θ結合

		- 直積から二つの属性X、Yを選択し、その二つの属性に選択条件［X θ Y］が成り立つタプルを取り出すもの

			- θ：比較演算子を指す→  ＜　＞　＜＝　＞＝　＝　＜＞など

	- 等結合

		- θ結合の比較演算子に“＝”を選んだ結合

	- 自然結合

		- 等結合から、二つ関係の共通属性を一つ除いて射影演算を行なったもの

	- 外部結合

		- 二つ関係のうち片方の関係に一致するものがない場合にも取り出す結合

			- 左外部結合

				- 左側の関係Rの行は全て取り出す、存在しない列にはNULLが挿入する

			- 右外部結合

				- 右

			- 完全外部結合（FULL OUTER JOIN）

				- どちらか存在すると取り出す

- 商（division）

	- 関係R➗関係S

		- SQLには直接存在しない、Sの関係を全て含むRの列を取り出す

## データベース設計

### 設計のアプローチ

- トップタウンアプローチ

	- E−R図の作成

		- リレーションシップやカーディナリティを洗い出し

	- 属性の洗い出し
	- 正規化

		- 1対多の場合、1の方の主キーを多の方の外部キーとして挿入するは一般です

- ボトムアップアプローチ

	- 属性の洗い出し
	- 正規化
	- E−R図の作成

### 制約

- 検査制約（CHECK制約）
- 非ナル制約（NOT NULL制約）
- 一意性制約（UNIQUE制約）
- 主キー制約（PRIMARY KEY制約）
- 参照制約（外部キー制約、FOREIGN KEY制約）

### データベースシステム設計

- CRUD分析

	- テーブルに対する四つの操作✖️業務処理の関係を見えるかして整理

- 決定表（decision  table：デシジョンテーブル）
- コード設計

	- 連番コード（シーケンスコード）
	- 桁別コード
	- 区分コード

- データ移行

	- データの保存方法（データベース、ファイルなど）
	- 更新の有無とタイミング
	- データ量
	- データ形式
	- 文字コード体系
	- など

### SQL

## SQL

## DBMS

### 機能

- メタデータ管理

	- データベースに関するデータを管理すること
	- DBMSの中にあるデータディクショナリに格納され

- 質問処理

	- 最適化行う機能のことをクエリオプティマイザとも呼ばれる

- トランザクション処理

	- 同時実行を制御
	- 障害時の回復処理

### インデックス

- 構造

	- Bツリー

		- B＋、B＊など
		- キーを検索してデータにアクセスするため、検索条件は非一つしか指定できず、ANDやORの条件指定などで複数のインデックスを同時に使うことができない

	- ビットマップ

		- 取り得る値の数が少なく、複雑な検索が行われる場合に利用される

	- ハッシュ

- 種類

	- ユニーク／非ユニークインデックス

		- キーとポインタの対関係

	- クラスタ化／非クラスタ化

		- キーごとにデータの格納位置を定め、同じ場所に格納することがある、この作業はクラスタ化といい、クラスタ化したデータのインデックスのことをクラスタ化インデックスといい

### 性能設計

- インデックス

	- INSERT、UPDATE、DELETE文では、使用するたびにインデックスの再構成の必要があり、処理が逆に遅くなる可能性もある（条件部分は普通に早くなるが）
	- ポイント

		- 一つのテーブルにインデックスを設定しすぎない
		- データ量が少ないときには設定しないほうがいい場合もある
		- クラスタ化インデックスは、頻繁に利用される一意性が高い列に設定する

			- クラスタ化インデックスは、一つのテーブルに一つしか設定できない

- 速度や処理時間の測定・演算

	- 索引検索は、索引を読み込んでからデータを読み込む
	- クラスタ化インデックスは、範囲内の複数のデータにアクセス可能
	- データだけでなくログの出力時間も考慮する

- ディスク容量の計算

	- テーブルの表領域の容量は、一般的に一行当たりの平均長（バイト）✖️見積もり行数

- パーテッション化

	- クラスタ化と類似で、キーではなくパーティションキー設定でデータを分割する

### テーブルの結合
アルゴリズム

- 入子ループ法（ネストループ法）

	- 単純に二重ループを使用してテーブルを結合する方法

- マージジョイン法

	- 二つのテーブルの結合列をあらかじめ整列（ソート）して置いてからか結合する方法

- セミジョイン法

	- 分散データベースで、結合に必要な属性だけを転送

- ハッシュジョイン法

	- あらかじめ結合列の値に対してハッシュ関数を用い、ハッシュ表を生成しておく、比較ではハッシュ比較にする

### ハードウェア

- 実際アクセス時間＝キャッシュメモリへのアクセス時間✖️ヒット率➕メモリへのアクセス時間✖️（1ーヒット率）

### トランザクション

### 障害回復

### 分散データベース

## 概念設計

### 注意点

- 弱実体

	- 依存関係がある、依存先がなくと単独存在できない実体

		- 対：通常実体／強実体

- スーパタイプ／サブタイプ
- どこまで正規化
- 命名ルール
- 一対一リレーションシップ

	- インスタンスが発生する実機に着目して、後ろからインスタンスが発生する側に外部キーを設定するのか基本

- 多対多リレーションシップ

	- 属性を全てかんりできないので　、連関エンティティを用いて1対多のリレーションシップに分解

		- 連関エンティティ→中間テーブルの位置付けで、一対多のリレーションシップに分ける

## 論理設計

### データベースとユーザやデータベース以外のシステムとを結びつけるための設計

- 外部設計で行われることが一般

	- CRUD分析、決定表、コード設計、データ移行など
	- システム開発はAPを参照

- テーブル構造だけでなく、テーブルに実際に入る値、つまり、インスタンス（データ）を設定し、値の動きを意識する必要がある

	- インスタンス設定に関して

		- 値の取得元
		- 値の設定、更新されるタイミング
		- 連動して更新される列や表

### 論理データ独立性

- システムとデータベースを独立させる＝概念設計と論理設計それぞれ実施する

### 移行設計

- 移行の準備
- 移行方式

	- パイロット移行、並行運用移行など、問題が発生ときに元に戻せるが大切

- テストと移行実施
- バージョンアによる移行
- 性能の測定シナリオ
- マスタデータの統合

## 物理設計

### DBMS仕様依存

- データページ

	- テーブル、索引のデータが格納される。表領域ごとに、ページサイズ（2000、4000、8000バイトなどの設定値）、空き領域率（将来予測含む）を指定する

- テーブル

	- 制約：NULL、主キー、参照、検査などある
	- データ型

		- AP／PostgreSQLのを参照

			- 全角／半角より、NCHAR／NCHAR VARYING や　CHAR／VARCHARを選択
			- 整数は範囲に応じて、SMALLINTやINTEGERを選択、それ以外はDECIMALを選択
			- 日付、時刻、時刻印の列は、専用のデータ型を選択

- 索引

	- ユニーク索引と非ユニーク索引

- DBの相互接続機能

	- 同じネットワーク上にある異なるDBを、相互接続する機能である、一つのSQL分解で操作することができる（DBの識別し．スキーマ名．テーブル名）

- エクスポートツール、インポートツール
- データ所要量の計算の順序

	- 見積もり行数
	- ページサイズ
	- 平均行長
	- 1 データページにあたりの平均行数
	- 必要データページ数
	- データ所要量

- 信頼性設計

	- AP参照

- 性能設計

	- パフォーマンスチューニング

		- 非正規化、導出属性の追加
		- インデックスの作成

			- オプティマイザ（最適化するためのソフトウェア）などを利用できる

		- SQLパフォーマンスチューニング
		- トランザクションの分離レベルを下げる
		- パーティンション化、ディスク分散
		- DBMS以外の手法、RAIDなど

- 運用・保守設計

	- 障害回復
	- メンテナンス

		- ディスクやインデックスの再編成や再構成など行う

	- 監視
	- 運用スケジュール設計
	- BCP（事業継続計画）

		- BCM（事業継続計画）

## RDB以外のデータベース

### NoSQL

- Not only SQL：関係データベース管理システム以外のデータベース全般を指す総称である

	- RDBMSで対応しづらい問題を解決するための仕組み

		- 大量のデータを高速に処理する場合にキャッシュとして利用
		- セッションデータを管理する
		- 分散データベースに使用する

			- 分散したサーバ同士での整合性が保証されないことが多いので、そうしたことがあまり要求されない用途に向いている

	- デメリット（不向き領域）

		- ほとんどはトランザクションをサポートしていない
		- スキーマがなく、データの性質を掴みにくい
		- 主キー以外の検索に向かない
		- 結果整合性

			- リアルタイムの反映が困難、「時間が経てば必ずストレージに最新情報が反映される」ことを保証する

	- 種類

		- KVS型データベース

			- Key−Value Store
			- オンメモリ型のKVSはキャッシュとしてよく利用されている

		- ドキュメント型データベース

			- JSONなど形式

		- カラムファミリー型データベース

			- BigTableなど、テーブルをベースにした構造を使用するが、複数の列をまとめたカラムファミリーという単位で管理

				- 列が非常に多くなるテーブルや、多くの列が空になるような非定型的なデータを扱い安くなる
				- 多くのサーバに分散することを前提に作られたデータベースなので、大量のデータを分散して処理する用途も優れている

		- グラフ型データベース

			- 各レコードがその他のレコードへのリンクをもつようなデータを格納するデータベース

				- ノード、エッジ、プロパティ三要素でノード間の関係性を表現

### データウェアハウス

- 挿入以外の更新、削除は行わないため、データの更新時異常は起こらない
- 抽出したデータは、全て一つのファクトテーブルに格納され。複数の関係データベースを統合する場合には、データクレンジングを行い、データの形式やコード体系を統一

	- 分析軸のデータはディメンション（次元：Dimension）テーブルに格納

- 操作

	- スライシング

		- 多次元のデータを2次元の表に切り取る操作

	- ダイシング（ダイス）

		- データの分析軸を返納し、視点を変える操作

	- ドリリング

		- ドリルアップ／ドリルダウン、ロールアップ／ロールダウン

- ETLツール

	- 基幹系のシステムなどに蓄積されたデータを抽出（Extract）し、利用しやすい形に加工（Transform）し、データウェアハウスに書き出す（Load）作業を行うツール

### オブジェクト指向データベース

- OODB

	- 実際工程上の問題点

		- 開発支援ツールや管理ツールの整備が不十分
		- 標準化があまり行われていない
		- リカバリ機能など、耐久性に関する機能が弱い
		- 大規模なデータの取扱いでの処理機能が弱い

- OODBMSやRDBMSよりのO−Rマッピング手法

### XMLDB

- XQueryがW3Cで標準化されている

## データベースの評価

RDBMSだけの話ではなくを注意

### 検索性能

- 質的な観点

	- 正確性や網羅性

- 量的な観点

### 分類性能評価指標

- 例

	- PositiveとNegativeの二つにデータを分類するシステム、予測と実際のマトリックスを作る

		- TP：予測と実際ともPositive
		- FP：予測はPositiveが、実際はNegative
		- FN：予測はNegativeが、実際はPositive
		- TN：予測と実際ともNegative

	- 評価指標

		- 正答率（Accuracy）

			- （TP＋TN）／（TP＋FP＋TN＋FN）

		- 精度（Precision）／適合率

			- TP／（TP＋FP）

		- 再現率（Recall）

			- TP／（TP＋FN）

		- F値（F−measure）

			- ２／（（１／Precision）＋（１／Recall））　
			- ２Precision＊Recall／（Precision＋Recall）

*XMind - Trial Version*